<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Muite | Muite</title><meta name="author" content="Muite"><meta name="copyright" content="Muite"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="微服务什么是微服务？微服务架构是一种将单一应用程序划分为一组小的、独立运行的服务的设计方法。每个服务都实现特定的业务功能，并且可以独立地部署和扩展。这些服务通过定义良好的API相互通信，它们通常是分布式的，部署在不同的服务器上或云环境中。 微服务的主要特点 模块化：每个微服务专注于单一的功能领域。 独立性：每个服务都可以独立开发、测试、部署和扩展。 轻量级通信：服务之间通常使用HTTP&#x2F;">
<meta property="og:type" content="article">
<meta property="og:title" content="Muite">
<meta property="og:url" content="https://mutesniper.github.io/2025/04/19/springCloudAlibaba/index.html">
<meta property="og:site_name" content="Muite">
<meta property="og:description" content="微服务什么是微服务？微服务架构是一种将单一应用程序划分为一组小的、独立运行的服务的设计方法。每个服务都实现特定的业务功能，并且可以独立地部署和扩展。这些服务通过定义良好的API相互通信，它们通常是分布式的，部署在不同的服务器上或云环境中。 微服务的主要特点 模块化：每个微服务专注于单一的功能领域。 独立性：每个服务都可以独立开发、测试、部署和扩展。 轻量级通信：服务之间通常使用HTTP&#x2F;">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://img.alicdn.com/bao/uploaded/i3/2200690044395/O1CN012NL22Q1iKxHYWb17f_!!2200690044395.jpg">
<meta property="article:published_time" content="2025-04-19T04:46:00.000Z">
<meta property="article:modified_time" content="2025-04-19T09:33:52.558Z">
<meta property="article:author" content="Muite">
<meta property="article:tag" content="note">
<meta property="article:tag" content="Microservices">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://img.alicdn.com/bao/uploaded/i3/2200690044395/O1CN012NL22Q1iKxHYWb17f_!!2200690044395.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "",
  "url": "https://mutesniper.github.io/2025/04/19/springCloudAlibaba/",
  "image": "https://img.alicdn.com/bao/uploaded/i3/2200690044395/O1CN012NL22Q1iKxHYWb17f_!!2200690044395.jpg",
  "datePublished": "2025-04-19T04:46:00.000Z",
  "dateModified": "2025-04-19T09:33:52.558Z",
  "author": [
    {
      "@type": "Person",
      "name": "Muite",
      "url": "https://mutesniper.github.io/"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://mutesniper.github.io/2025/04/19/springCloudAlibaba/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Failed',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Muite',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="stylesheet" href="/css/custom.css" media="defer" onload="this.media='all'"><!-- hexo injector head_end start --><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-footer-beautify@1.0.0/lib/runtime.css" media="print" onload="this.media='all'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head><body><div id="web_bg" style="background-image: url(/img/1990ee2c41564e328f35ac72f555f170.jpeg);"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="https://img.alicdn.com/bao/uploaded/i3/2200690044395/O1CN012NL22Q1iKxHYWb17f_!!2200690044395.jpg" onerror="this.onerror=null;this.src='/null'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">23</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">12</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">3</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"></a><a class="nav-page-title" href="/"><span class="site-name">Muite</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Untitled</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2025-04-19T04:46:00.000Z" title="Created 2025-04-19 12:46:00">2025-04-19</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2025-04-19T09:33:52.558Z" title="Updated 2025-04-19 17:33:52">2025-04-19</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/java-note/">java-note</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h2 id="微服务"><a href="#微服务" class="headerlink" title="微服务"></a>微服务</h2><h3 id="什么是微服务？"><a href="#什么是微服务？" class="headerlink" title="什么是微服务？"></a>什么是微服务？</h3><p><strong>微服务架构</strong>是一种将单一应用程序划分为一组小的、独立运行的服务的设计方法。每个服务都实现特定的业务功能，并且可以独立地部署和扩展。这些服务通过定义良好的API相互通信，它们通常是分布式的，部署在不同的服务器上或云环境中。</p>
<h4 id="微服务的主要特点"><a href="#微服务的主要特点" class="headerlink" title="微服务的主要特点"></a>微服务的主要特点</h4><ul>
<li><strong>模块化</strong>：每个微服务专注于单一的功能领域。</li>
<li><strong>独立性</strong>：每个服务都可以独立开发、测试、部署和扩展。</li>
<li><strong>轻量级通信</strong>：服务之间通常使用HTTP&#x2F;REST、gRPC等轻量级协议进行通信。</li>
<li><strong>去中心化治理</strong>：允许团队选择最适合他们需求的技术栈。</li>
<li><strong>数据分散管理</strong>：每个微服务可以拥有自己的数据库，以便于数据管理和性能优化。</li>
</ul>
<h3 id="为什么使用微服务？"><a href="#为什么使用微服务？" class="headerlink" title="为什么使用微服务？"></a>为什么使用微服务？</h3><p>采用微服务架构有多种好处，以下是一些主要的原因：</p>
<ol>
<li><strong>技术多样性</strong>：不同的服务可以使用不同的编程语言和技术栈来构建，这样可以根据具体的需求选择最合适的技术。</li>
<li><strong>加速上市时间</strong>：由于服务是独立的，因此可以单独对某个服务进行更新或改进，而不需要等待整个系统的完成，从而加快了新功能的发布速度。</li>
<li><strong>易于扩展</strong>：可以根据实际需要独立地扩展某些服务，而不是扩展整个应用，这有助于更有效地利用资源。</li>
<li><strong>增强的容错性和隔离性</strong>：如果一个服务出现问题，它不会影响其他服务的正常运作，提高了系统的稳定性和可靠性。</li>
<li><strong>简化维护</strong>：较小的代码库更容易理解和维护，而且问题定位更加简单，因为只需要关注出错的服务而不是整个系统。</li>
<li><strong>促进敏捷开发和DevOps实践</strong>：微服务架构鼓励持续集成和持续交付（CI&#x2F;CD），使得团队能够更快地响应变化并实施自动化部署流程。</li>
</ol>
<p>尽管微服务带来了许多优势，但同时也引入了复杂性，比如分布式系统的调试难度增加、服务间通信的成本以及数据一致性等问题。因此，在决定是否采用微服务架构时，需根据项目的具体情况权衡利弊。对于小型项目或者那些预计不会有太大增长的应用来说，单体架构可能是更合适的选择；而对于大型企业级应用或是预期会有快速发展的产品，则微服务架构可能提供更大的灵活性和可扩展性。</p>
<h1 id="分布式基础"><a href="#分布式基础" class="headerlink" title="分布式基础"></a>分布式基础</h1><h2 id="单体架构"><a href="#单体架构" class="headerlink" title="单体架构"></a>单体架构</h2><p>![屏幕截图 2025-03-23 161347](..&#x2F;assets&#x2F;屏幕截图 2025-03-23 161347.png)</p>
<h2 id="集群架构"><a href="#集群架构" class="headerlink" title="集群架构"></a>集群架构</h2><p>![屏幕截图 2025-03-23 161416](..&#x2F;assets&#x2F;屏幕截图 2025-03-23 161416.png)</p>
<h2 id="分布式架构"><a href="#分布式架构" class="headerlink" title="分布式架构"></a>分布式架构</h2><p>![屏幕截图 2025-03-23 161540](..&#x2F;assets&#x2F;屏幕截图 2025-03-23 161540.png)</p>
<p>![屏幕截图 2025-03-23 161547](..&#x2F;assets&#x2F;屏幕截图 2025-03-23 161547.png)</p>
<h1 id="Nacos"><a href="#Nacos" class="headerlink" title="Nacos"></a>Nacos</h1><p>在nacos的bin目录下使用<code>startup.cmd -m standalone </code>命令启动nacos。通过8848端口访问nacos</p>
<h2 id="注册中心"><a href="#注册中心" class="headerlink" title="注册中心"></a>注册中心</h2><h3 id="服务注册"><a href="#服务注册" class="headerlink" title="服务注册"></a>服务注册</h3><p>![屏幕截图 2025-03-23 172203](..&#x2F;assets&#x2F;屏幕截图 2025-03-23 172203.png)</p>
<p>在service-order模块的application.properties中加上</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.application.name</span>=<span class="string">service-order</span></span><br><span class="line"><span class="attr">server.port</span>=<span class="string">8000</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring.cloud.nacos.server-addr</span>=<span class="string">127.0.0.1:8848</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>再启动springboot应用</p>
<p>在nacos中会发现已经注册成功</p>
<h3 id="服务发现"><a href="#服务发现" class="headerlink" title="服务发现"></a>服务发现</h3><p>即获取注册中心所有的微服 务及其信息</p>
<p>![屏幕截图 2025-03-23 172211](..&#x2F;assets&#x2F;屏幕截图 2025-03-23 172211.png)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DiscovertyTest</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    DiscoveryClient discoveryClient;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">test01</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (String service : discoveryClient.getServices()) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;service:&quot;</span>+service);</span><br><span class="line">            <span class="comment">//获取ip和port</span></span><br><span class="line">            List&lt;ServiceInstance&gt; instances = discoveryClient.getInstances(service);</span><br><span class="line">            <span class="keyword">for</span> (ServiceInstance instance : instances) &#123;</span><br><span class="line">                System.out.println(instance.getHost()+<span class="string">&quot;:&quot;</span>+instance.getPort());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="编写微服务API"><a href="#编写微服务API" class="headerlink" title="编写微服务API"></a>编写微服务API</h3><p>远程调用基本流程：</p>
<p>![屏幕截图 2025-03-23 200647](..&#x2F;assets&#x2F;屏幕截图 2025-03-23 200647.png)</p>
<p>下面用一个订单-商品业务简单实现API，基本流程如下：</p>
<p>![屏幕截图 2025-03-23 200655](..&#x2F;assets&#x2F;屏幕截图 2025-03-23 200655.png)</p>
<p>实现：</p>
<ul>
<li><p>把bean类单独做成一个模块model，并将其作为services的dependency</p>
<p>order:</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Order</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> BigDecimal totalAmount;</span><br><span class="line">    <span class="keyword">private</span> Long userId;</span><br><span class="line">    <span class="keyword">private</span> String nickname;</span><br><span class="line">    <span class="keyword">private</span> String address;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Product&gt; productList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>​	product:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Product</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> id;</span><br><span class="line">    <span class="keyword">private</span> BigDecimal price;</span><br><span class="line">    <span class="keyword">private</span> String productName;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> num;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>service-product</p>
<ul>
<li><p>service:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProductServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">ProductService</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Product <span class="title function_">getProductById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="type">Product</span> <span class="variable">product</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Product</span>();</span><br><span class="line">        product.setId(id);</span><br><span class="line">        product.setPrice(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">&quot;99&quot;</span>));</span><br><span class="line">        product.setProductName(<span class="string">&quot;苹果&quot;</span>+id);</span><br><span class="line">        product.setNum(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> product;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>controller:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProductController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    ProductService productService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//查询商品</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/product/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Product <span class="title function_">getProduct</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;</span><br><span class="line">        Product product=productService.getProductById(id);</span><br><span class="line">        <span class="keyword">return</span> product;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<p>模拟了通过id查询商品的业务流程</p>
<ul>
<li><p>service-order:</p>
<ul>
<li>config:</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderSericeConfig</span> &#123;</span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line">RestTemplate <span class="title function_">restTemplate</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​	作用是注册一个RestTemplate组件，方便进行远程请求</p>
<ul>
<li>service:</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    DiscoveryClient discoveryClient;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Order <span class="title function_">createOrder</span><span class="params">(Long userId, Long productId)</span> &#123;</span><br><span class="line">        <span class="type">Product</span> <span class="variable">product</span> <span class="operator">=</span> getProductFromRemote(productId);</span><br><span class="line"></span><br><span class="line">        <span class="type">Order</span> <span class="variable">order</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Order</span>();</span><br><span class="line">        order.setId(<span class="number">1L</span>);</span><br><span class="line"></span><br><span class="line">        order.setTotalAmount(( product.getPrice().multiply(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(product.getNum()))));</span><br><span class="line">        order.setUserId(userId);</span><br><span class="line">        order.setNickname(<span class="string">&quot;zhangsan&quot;</span>);</span><br><span class="line">        order.setAddress(<span class="string">&quot;ss&quot;</span>);</span><br><span class="line">        order.setProductList(Arrays.asList(product));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> order;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Product <span class="title function_">getProductFromRemote</span><span class="params">(Long productId)</span>&#123;</span><br><span class="line">        <span class="comment">//获取所有商品服务所在的所有机器IP+port</span></span><br><span class="line">        List&lt;ServiceInstance&gt; instances = discoveryClient.getInstances(<span class="string">&quot;service-product&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">ServiceInstance</span> <span class="variable">serviceInstance</span> <span class="operator">=</span> instances.get(<span class="number">0</span>);</span><br><span class="line">        <span class="comment">//远程url</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;http://&quot;</span>+serviceInstance.getHost() + <span class="string">&quot;:&quot;</span> + serviceInstance.getPort()+<span class="string">&quot;/product/&quot;</span>+productId;</span><br><span class="line">        log.info(<span class="string">&quot;远程请求: &#123;&#125;&quot;</span>+url);</span><br><span class="line">        <span class="comment">//给远程发送请求</span></span><br><span class="line">        <span class="type">Product</span> <span class="variable">product</span> <span class="operator">=</span> restTemplate.getForObject(url, Product.class);</span><br><span class="line">        <span class="keyword">return</span> product;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>controller：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    OrderService orderService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping(&quot;/create&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Order <span class="title function_">createOrder</span><span class="params">(<span class="meta">@RequestParam(&quot;userId&quot;)</span> Long userId,</span></span><br><span class="line"><span class="params">                             <span class="meta">@RequestParam(&quot;productId&quot;)</span> Long productId)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Order</span> <span class="variable">order</span> <span class="operator">=</span> orderService.createOrder(userId, productId);</span><br><span class="line">        <span class="keyword">return</span> order;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<p>模拟了不同服务器之间的模块之间的远程调用</p>
<h4 id="负载均衡API"><a href="#负载均衡API" class="headerlink" title="负载均衡API"></a>负载均衡API</h4><p>上面的API每次都给一个固定的位置发远程请求，但在真实环境中，如果这个服务器的这个组件出了故障，就会导致系统崩溃。所以我们考虑实现负载均衡API：能够以某种规则每次给不同服务器的相同业务模块发送远程请求。</p>
<p>步骤：</p>
<p>![屏幕截图 2025-03-23 200823](..&#x2F;assets&#x2F;屏幕截图 2025-03-23 200823.png)</p>
<ul>
<li><p>在service-order中引入负载均衡依赖</p>
</li>
<li><p>修改service-order中的方法<code>getProductFromRemote</code>为<code>getProductFromRemoteWithLoadBalancer</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">private</span> Product <span class="title function_">getProductFromRemoteWithLoadBalancer</span><span class="params">(Long productId)</span>&#123;</span><br><span class="line">        <span class="comment">//获取所有商品服务所在的所有机器IP+port</span></span><br><span class="line">        ServiceInstance choose=loadBalancerClient.choose(<span class="string">&quot;service-product&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//远程url</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;http://&quot;</span>+choose.getHost() + <span class="string">&quot;:&quot;</span> + choose.getPort()+<span class="string">&quot;/product/&quot;</span>+productId;</span><br><span class="line">        log.info(<span class="string">&quot;远程请求: &#123;&#125;&quot;</span>+url);</span><br><span class="line">        <span class="comment">//给远程发送请求</span></span><br><span class="line">        <span class="type">Product</span> <span class="variable">product</span> <span class="operator">=</span> restTemplate.getForObject(url, Product.class);</span><br><span class="line">        <span class="keyword">return</span> product;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>用注解进行负载均衡:</p>
<ul>
<li><p>给restTemplate加上注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@LoadBalanced</span>    </span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line">RestTemplate <span class="title function_">restTemplate</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Product <span class="title function_">getProductFromRemoteWithLoadBalancerAnnotation</span><span class="params">(Long productId)</span>&#123;</span><br><span class="line">    <span class="comment">//获取所有商品服务所在的所有机器IP+port</span></span><br><span class="line">    <span class="comment">//ServiceInstance choose=loadBalancerClient.choose(&quot;service-product&quot;);</span></span><br><span class="line">    <span class="comment">//远程url</span></span><br><span class="line">    <span class="comment">//String url = &quot;http://&quot;+choose.getHost() + &quot;:&quot; + choose.getPort()+&quot;/product/&quot;+productId;</span></span><br><span class="line">    String url=<span class="string">&quot;http://service-product/product/&quot;</span>+productId;</span><br><span class="line">    log.info(<span class="string">&quot;远程请求: &quot;</span>+url);</span><br><span class="line">    <span class="comment">//给远程发送请求   url中的service-product会被动态替换成负载均衡的地址</span></span><br><span class="line">    <span class="type">Product</span> <span class="variable">product</span> <span class="operator">=</span> restTemplate.getForObject(url, Product.class);</span><br><span class="line">    <span class="keyword">return</span> product;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h4><p>如果注册中心宕机了（微服务正常运行），还能进行远程调用吗:</p>
<ul>
<li>进行远程调用的流程：<ul>
<li>请求注册中心，获取微服务地址列表</li>
<li>负载均衡地发送请求</li>
</ul>
</li>
<li>使用过的微服务实例会有缓存，再次调用就不需要访问注册中心了</li>
<li>所以：<ul>
<li>调用过，可以</li>
<li>没调用过（第一次发起远程调用），不行</li>
</ul>
</li>
</ul>
<h2 id="配置中心"><a href="#配置中心" class="headerlink" title="配置中心"></a>配置中心</h2><h3 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h3><p>![屏幕截图 2025-03-23 210150](..&#x2F;assets&#x2F;屏幕截图 2025-03-23 210150.png)</p>
<ul>
<li><p>引入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>指定配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spring.config.import=nacos:service-order.properties</span><br></pre></td></tr></table></figure>
</li>
<li><p>在nacos中创建配置</p>
</li>
<li><p>编写API进行测试：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Value(&quot;$&#123;order.timeout&#125;&quot;)</span></span><br><span class="line">String ordertimeout;</span><br><span class="line"><span class="meta">@Value(&quot;$&#123;order.auto-confirm&#125;&quot;)</span></span><br><span class="line">String orderautoConfirm;</span><br><span class="line">  </span><br><span class="line"><span class="meta">@GetMapping(&quot;/config&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">config</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ordertimeout+orderautoConfirm;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>注意：在导入依赖后，如果不在application.properties中指定配置，会报错。</p>
<p>​			如果此时我们不需要配置，那么用<code>spring.cloud.nacos.config.import-check.enabled=false</code>改成不必须配置。</p>
<h4 id="动态刷新"><a href="#动态刷新" class="headerlink" title="动态刷新"></a>动态刷新</h4><ul>
<li><p>此时还不能做到在不重启项目的情况下自动刷新配置的更改，如果想要自动刷新，还要再controller上加上注解：</p>
<p><code>	@RefreshScope</code></p>
</li>
<li><p>自动刷新的方便做法：使用spring注解<code>@ConfigurationProperties()</code>   :		</p>
<p>创建一个properties包 ,创建orderProperties类，进行注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;order&quot;)</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderProperties</span> &#123;</span><br><span class="line">    </span><br><span class="line">    String timeout;</span><br><span class="line">    </span><br><span class="line">    String autoConfirm;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"> OrderProperties orderProperties;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@GetMapping(&quot;/config&quot;)</span></span><br><span class="line"> <span class="keyword">public</span> String <span class="title function_">config</span><span class="params">()</span>&#123;</span><br><span class="line">     <span class="keyword">return</span> orderProperties.getTimeout()+orderProperties.getAutoConfirm();</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="配置监听"><a href="#配置监听" class="headerlink" title="配置监听"></a>配置监听</h4><p>模拟一个场景：</p>
<p>我们想要：</p>
<ol>
<li>项目启动就开始监听配置文件的变化</li>
<li>发生变化后拿到变化值</li>
<li>发送邮件</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line">ApplicationRunner <span class="title function_">applicationRunner</span><span class="params">(NacosConfigManager nacosConfigManager)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> args-&gt; &#123;</span><br><span class="line">        <span class="type">ConfigService</span> <span class="variable">configService</span> <span class="operator">=</span> nacosConfigManager.getConfigService();</span><br><span class="line">        configService.addListener(<span class="string">&quot;service-order.properties&quot;</span>, </span><br><span class="line">                                  <span class="string">&quot;DEFAULT_GROUP&quot;</span>, </span><br><span class="line">                                  <span class="keyword">new</span> <span class="title class_">Listener</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> Executor <span class="title function_">getExecutor</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> Executors.newFixedThreadPool(<span class="number">4</span>); <span class="comment">//线程池</span></span><br><span class="line">            &#125;</span><br><span class="line"><span class="comment">//输出配置信息</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receiveConfigInfo</span><span class="params">(String s)</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;变化的配置信息&quot;</span>+s);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        System.out.println(<span class="string">&quot;===========&quot;</span>);</span><br><span class="line">        </span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>ApplicationRunner是一个项目一启动就会执行的任务</li>
</ul>
<h4 id="思考-1"><a href="#思考-1" class="headerlink" title="思考"></a>思考</h4><p>如果同一个配置在微服务和配置中心都进行了配置，以哪个为准？<br>还是那个规则：</p>
<p>先导入优先、外部优先</p>
<p><strong>配置中心为准</strong></p>
<h3 id="数据隔离"><a href="#数据隔离" class="headerlink" title="数据隔离"></a>数据隔离</h3><ul>
<li><p>需求描述</p>
<ul>
<li><p>项目有多套环境：dev，test，prod</p>
</li>
<li><p>每个微服务，同一种配置，在每套环境的值都不一样。</p>
</li>
<li><p>如：database.properties</p>
</li>
<li><p>如：common.properties</p>
</li>
<li><p>项目可以通过切换环境，加载本环境的配置</p>
</li>
</ul>
</li>
<li><p>难点</p>
<ul>
<li>区分多套环境</li>
<li>区分多种微服务</li>
<li>区分多种配置</li>
<li>按需加载配置</li>
</ul>
<img src="../assets/屏幕截图 2025-03-23 215635.png" alt="屏幕截图 2025-03-23 215635" style="zoom:67%;" /></li>
</ul>
<p>一个namespace对应一种开发环境、一个group对应一个微服务（order、product）。</p>
<p>在nacos中创建好配置后，需要实现按需加载<br>因为properties如果配置多了显得很乱，所以我们改用yml</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">service-order</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span> <span class="comment">#激活环境</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">$&#123;spring.profiles.active:dev&#125;</span> <span class="comment">#动态配置环境，默认dev</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 不同环境进行不同的配置</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">config:</span></span><br><span class="line">    <span class="attr">import:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nacos:common.properties?group=order</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nacos:database.properties?group=order</span></span><br><span class="line">    <span class="attr">activate:</span></span><br><span class="line">      <span class="attr">on-profile:</span> <span class="string">dev</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">config:</span></span><br><span class="line">    <span class="attr">import:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nacos:common.properties?group=order</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nacos:database.properties?group=order</span></span><br><span class="line">    <span class="attr">activate:</span></span><br><span class="line">      <span class="attr">on-profile:</span> <span class="string">test</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">config:</span></span><br><span class="line">    <span class="attr">import:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nacos:common.properties?group=order</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nacos:database.properties?group=order</span></span><br><span class="line">    <span class="attr">activate:</span></span><br><span class="line">      <span class="attr">on-profile:</span> <span class="string">prod</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>并且在OrderProperties类中加上相应的属性</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>![屏幕截图 2025-03-23 223552](..&#x2F;assets&#x2F;屏幕截图 2025-03-23 223552.png)</p>
<h1 id="OpenFeign"><a href="#OpenFeign" class="headerlink" title="*OpenFeign"></a>*OpenFeign</h1><h2 id="远程调用"><a href="#远程调用" class="headerlink" title="远程调用"></a>远程调用</h2><p>在nacos学习中，我们已经使用了远程调用，但那是编程式 REST客户端。</p>
<p>而OpenFeign是springcloud用来做远程调用的组件，是一种声明式的REST客户端（Declared REST Client）。</p>
<p><strong>rest客户端就是能发送HTTP请求进行远程调用的工具</strong></p>
<ul>
<li><p>注解驱动</p>
<ul>
<li><p>指定远程地址：@FeignClient</p>
</li>
<li><p>指定请求方式：@GetMapping、@PostMapping、@DeleteMapping … </p>
</li>
<li><p>指定携带数据：@RequestHeader、@RequestParam、@RequestBody … </p>
</li>
<li><p>指定结果返回：响应模型</p>
</li>
</ul>
</li>
</ul>
<h3 id="声明式实现"><a href="#声明式实现" class="headerlink" title="声明式实现"></a>声明式实现</h3><p><strong>第一步</strong>:</p>
<p>依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在主程序标注注解用来开启Feign远程调用功能。<code>@EnableFeignClients</code></p>
<p><strong>第二步</strong>：</p>
<p>编写远程调用的客户端</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.order.feign;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atguigu.product.bean.Product;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.FeignClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"></span><br><span class="line"><span class="comment">//说明这是一个远程调用的Feign客户端，并指定服务名</span></span><br><span class="line"><span class="meta">@FeignClient(value = &quot;service-product&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ProductFeignClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//MVC注解的两套使用逻辑</span></span><br><span class="line">    <span class="comment">//1.标注在controller上：接收这样的请求</span></span><br><span class="line">    <span class="comment">//2.标注在FeignClient上：发送这样的请求</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/product/&#123;id&#125;&quot;)</span></span><br><span class="line">    Product <span class="title function_">getProductById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span>;</span><br><span class="line">    <span class="comment">//这里的参数作用也是和controller相反的，表示将id传递给uri</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><strong>第三步</strong>:</p>
<p>在OrderServiceImpl中自动注入productFeignClient</p>
<p>并</p>
<p>修改OrderServiceImpl中方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Product product = getProductFromRemoteWithLoadBalancerAnnotation(productId);</span></span><br><span class="line"><span class="comment">//使用Feign代替RESTtemplate完成远程调用</span></span><br><span class="line">Product product=productFeignClient.getProductById(productId);</span><br></pre></td></tr></table></figure>



<p>经过测试已经可以实现<strong>负载均衡的远程调用</strong>了</p>
<h3 id="第三方API"><a href="#第三方API" class="headerlink" title="第三方API"></a>第三方API</h3><p>上面是给我们自己注册的服务发送远程调用，除此之外，我们还可以对第三方API发送远程调用：</p>
<p>以墨迹天气为例：</p>
<p>WeatherFeignClient:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.order.feign;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.FeignClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PostMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestHeader;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"></span><br><span class="line"><span class="meta">@FeignClient(value=&quot;weather-client&quot;,url=&quot;http://aliv18.data.moji.com&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">WeatherFeignClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/whapi/json/alicityweather/condition&quot;)</span></span><br><span class="line">    String <span class="title function_">getWeather</span><span class="params">(<span class="meta">@RequestHeader(&quot;Authorization&quot;)</span> String auth,</span></span><br><span class="line"><span class="params">                      <span class="meta">@RequestParam(&quot;token&quot;)</span> String token,</span></span><br><span class="line"><span class="params">                      <span class="meta">@RequestParam(&quot;cityId&quot;)</span> String cityId)</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>test:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WeatherTest</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    WeatherFeignClient weatherFeignClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">test01</span><span class="params">()</span> &#123;</span><br><span class="line">        String weather=weatherFeignClient.getWeather(<span class="string">&quot;APPCODE 93b7e19861a24c519a7548b17dc16d75&quot;</span>,</span><br><span class="line">                                                     <span class="string">&quot;50b53ff8dd7d9fa320d3d3ca32cf8ed1&quot;</span>,</span><br><span class="line">                                                     <span class="string">&quot;2182&quot;</span>                );</span><br><span class="line">        System.out.println(weather);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>成功输出：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;code&quot;</span><span class="punctuation">:</span><span class="number">0</span><span class="punctuation">,</span><span class="attr">&quot;data&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;city&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;cityId&quot;</span><span class="punctuation">:</span><span class="number">2182</span><span class="punctuation">,</span><span class="attr">&quot;counname&quot;</span><span class="punctuation">:</span><span class="string">&quot;中国&quot;</span><span class="punctuation">,</span><span class="attr">&quot;ianatimezone&quot;</span><span class="punctuation">:</span><span class="string">&quot;Asia/Shanghai&quot;</span><span class="punctuation">,</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;西安市&quot;</span><span class="punctuation">,</span><span class="attr">&quot;pname&quot;</span><span class="punctuation">:</span><span class="string">&quot;陕西省&quot;</span><span class="punctuation">,</span><span class="attr">&quot;secondaryname&quot;</span><span class="punctuation">:</span><span class="string">&quot;陕西省&quot;</span><span class="punctuation">,</span><span class="attr">&quot;timezone&quot;</span><span class="punctuation">:</span><span class="string">&quot;8&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="attr">&quot;condition&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;condition&quot;</span><span class="punctuation">:</span><span class="string">&quot;阴&quot;</span><span class="punctuation">,</span><span class="attr">&quot;conditionId&quot;</span><span class="punctuation">:</span><span class="string">&quot;85&quot;</span><span class="punctuation">,</span><span class="attr">&quot;humidity&quot;</span><span class="punctuation">:</span><span class="string">&quot;29&quot;</span><span class="punctuation">,</span><span class="attr">&quot;icon&quot;</span><span class="punctuation">:</span><span class="string">&quot;2&quot;</span><span class="punctuation">,</span><span class="attr">&quot;pressure&quot;</span><span class="punctuation">:</span><span class="string">&quot;981&quot;</span><span class="punctuation">,</span><span class="attr">&quot;realFeel&quot;</span><span class="punctuation">:</span><span class="string">&quot;5&quot;</span><span class="punctuation">,</span><span class="attr">&quot;sunRise&quot;</span><span class="punctuation">:</span><span class="string">&quot;2025-03-29 06:36:00&quot;</span><span class="punctuation">,</span><span class="attr">&quot;sunSet&quot;</span><span class="punctuation">:</span><span class="string">&quot;2025-03-29 19:03:00&quot;</span><span class="punctuation">,</span><span class="attr">&quot;temp&quot;</span><span class="punctuation">:</span><span class="string">&quot;7&quot;</span><span class="punctuation">,</span><span class="attr">&quot;tips&quot;</span><span class="punctuation">:</span><span class="string">&quot;天冷了，该加衣服了！&quot;</span><span class="punctuation">,</span><span class="attr">&quot;updatetime&quot;</span><span class="punctuation">:</span><span class="string">&quot;2025-03-29 23:05:08&quot;</span><span class="punctuation">,</span><span class="attr">&quot;uvi&quot;</span><span class="punctuation">:</span><span class="string">&quot;1&quot;</span><span class="punctuation">,</span><span class="attr">&quot;vis&quot;</span><span class="punctuation">:</span><span class="string">&quot;9700&quot;</span><span class="punctuation">,</span><span class="attr">&quot;windDegrees&quot;</span><span class="punctuation">:</span><span class="string">&quot;270&quot;</span><span class="punctuation">,</span><span class="attr">&quot;windDir&quot;</span><span class="punctuation">:</span><span class="string">&quot;西风&quot;</span><span class="punctuation">,</span><span class="attr">&quot;windLevel&quot;</span><span class="punctuation">:</span><span class="string">&quot;1&quot;</span><span class="punctuation">,</span><span class="attr">&quot;windSpeed&quot;</span><span class="punctuation">:</span><span class="string">&quot;0.89&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="attr">&quot;msg&quot;</span><span class="punctuation">:</span><span class="string">&quot;success&quot;</span><span class="punctuation">,</span><span class="attr">&quot;rc&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;c&quot;</span><span class="punctuation">:</span><span class="number">0</span><span class="punctuation">,</span><span class="attr">&quot;p&quot;</span><span class="punctuation">:</span><span class="string">&quot;success&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h3 id="小技巧"><a href="#小技巧" class="headerlink" title="小技巧:"></a>小技巧:</h3><p>当调用业务API（我们自己注册的服务）时，直接将controller对应的方法签名复制到feign接口中进行声名</p>
<p>比如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/create&quot;)</span></span><br><span class="line">   <span class="keyword">public</span> Order <span class="title function_">createOrder</span><span class="params">(<span class="meta">@RequestParam(&quot;userId&quot;)</span> Long userId,</span></span><br><span class="line"><span class="params">                            <span class="meta">@RequestParam(&quot;productId&quot;)</span> Long productId)</span> &#123;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>第三方API：根据接口文档确定请求如何发</p>
<p>客户端负载均衡与服务端负载均衡区别</p>
<img src="../assets/屏幕截图 2025-03-30 083535.png" alt="屏幕截图 2025-03-30 083535" style="zoom:67%;" />



<h2 id="进阶配置"><a href="#进阶配置" class="headerlink" title="进阶配置"></a>进阶配置</h2><h3 id="日志"><a href="#日志" class="headerlink" title="日志"></a>日志</h3><p>配置信息:</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">com.atguigu.order.feign:</span> <span class="string">debug</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在容器中加入组件:</p>
<p>在OrderServiceConfig中添加：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line">Logger.Level <span class="title function_">feignLoogerLevel</span><span class="params">()</span>&#123;</span><br><span class="line">     <span class="keyword">return</span> Logger.Level.FULL;</span><br><span class="line">&#125;          </span><br></pre></td></tr></table></figure>

<p>接下来在发送远程调用请求时，就会多出日志。</p>
<h3 id="超时控制"><a href="#超时控制" class="headerlink" title="超时控制"></a>超时控制</h3><p>在远程调用时，如果OpenFeign远程调用的服务器宕机或速度太慢，容易造成雪崩。这时就需要进行超时控制。</p>
<p>超时又分两种：</p>
<img src="../assets/屏幕截图 2025-03-30 085338.png" alt="屏幕截图 2025-03-30 085338" style="zoom: 67%;" />



<p>接下来我们模拟超时的情况：<br>在productServiceImpl中睡眠100秒：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    TimeUnit.SECONDS.sleep(<span class="number">100</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>接下来启动order向product发送远程请求，在等待60秒后，返回了错误信息。</p>
<p>下面来修改配置，因为application.yml中配置过多，我们新创一个<code>application-feign.yml</code>，其中的feign是环境标识，为了让此环境生效，在<code>application.yml</code>中进行如下配置</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span> </span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">include:</span> <span class="string">feign</span></span><br></pre></td></tr></table></figure>

<p>然后在<code>application-feign.yml</code>中进行如下配置：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">openfeign:</span></span><br><span class="line">      <span class="attr">client:</span></span><br><span class="line">        <span class="attr">config:</span></span><br><span class="line">          <span class="attr">default:</span></span><br><span class="line">            <span class="attr">logger-level:</span> <span class="string">full</span></span><br><span class="line">            <span class="attr">connect-timeout:</span> <span class="number">1000</span></span><br><span class="line">            <span class="attr">read-timeout:</span> <span class="number">2000</span></span><br><span class="line">          <span class="attr">service-product:</span></span><br><span class="line">            <span class="attr">logger-level:</span> <span class="string">full</span></span><br><span class="line">            <span class="attr">connect-timeout:</span> <span class="number">3000</span></span><br><span class="line">            <span class="attr">read-timeout:</span> <span class="number">5000</span></span><br></pre></td></tr></table></figure>

<p>表示默认配置和指定配置，其中指定配置的名字（这里是service-product）取决于@FeignClient注解中<code>connentId</code>指定的值，如果没有<code>connentId</code>，那就是<code>value</code>指定的。</p>
<h3 id="重试机制"><a href="#重试机制" class="headerlink" title="重试机制"></a>重试机制</h3><p>远程调用超时失败后，还可以进行多次尝试，如果某次成功返回ok，如果多次依然失败则结束调用，返回错误</p>
<p>底层是默认不重试的，如果要设置重试，进行如下配置；</p>
<p>给容器中放入Retryer组件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line">Retryer <span class="title function_">retryer</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Retryer</span>.Default();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里使用的是默认配置，如果想要修改，那么return中使用有参构造器，第一个参数是请求失败与第一次重试之间的间隔，之后每次请求失败与下一次重试之间的间隔都乘以1.5，第二个参数是请求失败与下一次重试之间的间隔的最大值，乘以1.5超过这个值就按这个值算。第三个参数是最大请求次数（包含第一次请求）</p>
<h3 id="拦截器"><a href="#拦截器" class="headerlink" title="拦截器"></a>拦截器</h3><p>在进行远程调用前，对OpenFeign发送的请求进行定制修改，使用了<strong>请求拦截器</strong>，在响应时，也可以使用<strong>响应拦截器</strong>进行响应预处理。</p>
<p>我们以请求拦截器为例，我们需要在请求头中放一个X-Token，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.order.interceptor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> feign.RequestInterceptor;</span><br><span class="line"><span class="keyword">import</span> feign.RequestTemplate;</span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">XTokenRequestInterceptor</span> <span class="keyword">implements</span> <span class="title class_">RequestInterceptor</span> &#123;</span><br><span class="line">    <span class="comment">//此次请求的详细信息封装到了requestTemplate中，</span></span><br><span class="line">    <span class="comment">// 想要对请求进行修改，只需要对requestTemplate进行修改</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">apply</span><span class="params">(RequestTemplate requestTemplate)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;XTokenRequestInterceptor......&quot;</span>);</span><br><span class="line">        requestTemplate.header(<span class="string">&quot;X-Token&quot;</span>, UUID.randomUUID().toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>要启用拦截器，可以在配置文件中进行设置，也可以在容器中加入组件</p>
<p>这里采用组件方式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line">XTokenRequestInterceptor <span class="title function_">xTokenRequestInterceptor</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">XTokenRequestInterceptor</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在productcontroller中加入测试逻辑</p>
<p>为了不影响编码，使用原生的HttpServletRequest</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/product/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Product <span class="title function_">getProduct</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id,</span></span><br><span class="line"><span class="params">                          HttpServletRequest request)</span> &#123;</span><br><span class="line">    String head=request.getHeader(<span class="string">&quot;X-Token&quot;</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;token=&quot;</span>+head);</span><br><span class="line">    Product product=productService.getProductById(id);</span><br><span class="line">    <span class="keyword">return</span> product;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试成功。</p>
<h3 id="Fallback-兜底返回"><a href="#Fallback-兜底返回" class="headerlink" title="*Fallback(兜底返回)"></a>*Fallback(兜底返回)</h3><img src="../assets/屏幕截图 2025-03-30 100855.png" alt="屏幕截图 2025-03-30 100855" style="zoom:75%;" />

<p>下面进行测试:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.order.feign.fallback;</span><br><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.atguigu.order.feign.ProductFeignClient;</span><br><span class="line"><span class="keyword">import</span> com.atguigu.product.bean.Product;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="comment">//加入组件</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProductFeignClientFallback</span> <span class="keyword">implements</span> <span class="title class_">ProductFeignClient</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Product <span class="title function_">getProductById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;兜底回调&quot;</span>);</span><br><span class="line">        <span class="type">Product</span> <span class="variable">product</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Product</span>();</span><br><span class="line">        product.setId(id);</span><br><span class="line">        product.setPrice(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">&quot;0&quot;</span>));</span><br><span class="line">        product.setProductName(<span class="string">&quot;未知商品&quot;</span>);</span><br><span class="line">        product.setNum(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> product;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后，在对应的FeignCLient中的@FeignClient注解中加上<code>fallback=ProductFeignClientFallback.class</code></p>
<p>进行测试也非常简单，只需要把product服务关闭再发送请求。</p>
<p>但是，返回兜底数据需要配合sentinel，这边进行一个快速配置</p>
<p>导入sentinel依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>启用熔断:</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">sentinel:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>在进行远程调用发现兜底成功</p>
<h1 id="Sentinel"><a href="#Sentinel" class="headerlink" title="Sentinel"></a>Sentinel</h1><h2 id="引入"><a href="#引入" class="headerlink" title="引入"></a>引入</h2><p>随着微服务的流行，服务和服务之间的稳定性变得越来越重要。Spring CloudAlibaba Sentinel 以流量为切入点，从流量控制、流量路由、熔断降级、系统自适应过载保护、热点流量防护等多个维度保护服务的稳定性。</p>
<p>架构原理：</p>
<img src="../assets/屏幕截图 2025-03-30 103855.png" alt="屏幕截图 2025-03-30 103855" style="zoom:75%;" />

<p>资源&amp;规则<br><img src="../assets/屏幕截图 2025-03-30 103946.png" alt="屏幕截图 2025-03-30 103946" style="zoom:75%;" /></p>
<p>工作原理</p>
<img src="../assets/屏幕截图 2025-03-30 103952.png" alt="屏幕截图 2025-03-30 103952" style="zoom:75%;" />



<h2 id="整合-基础使用"><a href="#整合-基础使用" class="headerlink" title="整合&#x2F;基础使用"></a>整合&#x2F;基础使用</h2><p>cmd使用<code>java -Dserver.port=9090 -jar sentinel-dashboard-1.8.8.jar</code>在9090端口启动sentinel dashboard。</p>
<p>在services模块中引入sentinel依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>然后，每一个微服务都需要连接上sentinel控制台:</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">sentinel:</span></span><br><span class="line">      <span class="attr">transport:</span></span><br><span class="line">        <span class="attr">dashboard:</span> <span class="string">localhost:9090</span></span><br></pre></td></tr></table></figure>

<p>而且sentinel默认的是懒加载机制，只有访问了请求，在控制台才会显示出应用的信息。所以为了方便起见</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">sentinel:</span></span><br><span class="line">      <span class="string">eager:true</span></span><br></pre></td></tr></table></figure>





<p>定义资源：<br>使用注解<code>@SentinelResource(value=)</code>给OrderServiceImpl中的方法定义为资源:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SentinelResource(value = &quot;createOrder&quot;)</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Order <span class="title function_">createOrder</span><span class="params">(Long userId, Long productId)</span> &#123;</span><br></pre></td></tr></table></figure>

<p>在启动项目并发送<code>(http://localhost:8000/create?userId=2&amp;productId=100)</code>请求后，在sentinel控制台的service-order服务的簇点链路中可以发现create资源和createOrder资源，其中前者由于是API，被sentinel自动识别为资源，而后者则是我们用注解手动添加的。</p>
<p>现在我们对create资源设置流控规则来进行演示</p>
<img src="../assets/屏幕截图 2025-03-30 112050.png" alt="屏幕截图 2025-03-30 112050" style="zoom:67%;" />

<p>代表每秒最多一个请求，如果我们快速刷新以模拟快速请求：</p>
<img src="../assets/屏幕截图 2025-03-30 112124.png" alt="屏幕截图 2025-03-30 112124" style="zoom:75%;" />

<p>被阻塞的请求不会执行目标方法，那么就不会占用系统资源，即使高并发的场景，只有少量的目标方法执行并占用系统资源，那么就不会导致服务雪崩的问题。</p>
<h2 id="异常处理"><a href="#异常处理" class="headerlink" title="*异常处理"></a>*异常处理</h2><p>但是现在请求被限制以后，返回的是默认sentinel的错误提示页，而我们需要给前端返回json数据,类似于：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;code&quot;</span><span class="punctuation">:</span><span class="string">&quot;500&quot;</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;msg&quot;</span><span class="punctuation">:</span><span class="string">&quot;流量超出限制&quot;</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;data&quot;</span><span class="punctuation">:</span><span class="string">&quot;&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<img src="../assets/屏幕截图 2025-03-30 133627.png" alt="屏幕截图 2025-03-30 133627" style="zoom: 67%;" />

<p>其中@SentinelResoruce标注在非controller层</p>
<h3 id="web接口"><a href="#web接口" class="headerlink" title="web接口"></a>web接口</h3><p>DefaultBlockExceptionHandler是sentinel定义的专门用来处理springmvc的web接口异常的handler。它实现了BlockExceptionHandler接口。</p>
<p>所以想要自定义异常处理，就要自定义类来实现BlockExceptionHandler接口。</p>
<p>定义返回的对象R:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">R</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer code;</span><br><span class="line">    <span class="keyword">private</span> String msg;</span><br><span class="line">    <span class="keyword">private</span> Object data;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> R <span class="title function_">ok</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">R</span> <span class="variable">r</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">R</span>();</span><br><span class="line">        r.setCode(<span class="number">200</span>);</span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> R <span class="title function_">ok</span><span class="params">(String msg,Object data)</span> &#123;</span><br><span class="line">        <span class="type">R</span> <span class="variable">r</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">R</span>();</span><br><span class="line">        r.setCode(<span class="number">200</span>);</span><br><span class="line">        r.setMsg(msg);</span><br><span class="line">        r.setData(data);</span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> R <span class="title function_">error</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">R</span> <span class="variable">r</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">R</span>();</span><br><span class="line">        r.setCode(<span class="number">500</span>);</span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> R <span class="title function_">error</span><span class="params">(Integer code,String msg)</span> &#123;</span><br><span class="line">        <span class="type">R</span> <span class="variable">r</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">R</span>();</span><br><span class="line">        r.setCode(code);</span><br><span class="line">        r.setMsg(msg);</span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>定义异常处理器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyBlockExceptionHandler</span> <span class="keyword">implements</span> <span class="title class_">BlockExceptionHandler</span> &#123;</span><br><span class="line">    <span class="comment">//springMVC底层整合了jackson提供的一个JSON工具</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">ObjectMapper</span> <span class="variable">objectMapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse,</span></span><br><span class="line"><span class="params">                       String s, BlockException e)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        httpServletResponse.setContentType(<span class="string">&quot;application/json;charset=utf-8&quot;</span>);</span><br><span class="line">        <span class="type">PrintWriter</span> <span class="variable">writer</span> <span class="operator">=</span> httpServletResponse.getWriter();</span><br><span class="line">        R error=R.error(<span class="number">500</span>,s+<span class="string">&quot;被Sentinel限制了，原因：&quot;</span>+ e.getClass());</span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> objectMapper.writeValueAsString(error);</span><br><span class="line">        writer.write(json);</span><br><span class="line">        writer.flush();</span><br><span class="line">        writer.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试：</p>
<p>返回：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">500</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;msg&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/create被Sentinel限制了，原因：class com.alibaba.csp.sentinel.slots.block.flow.FlowException&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>



<h3 id="SentinelResource"><a href="#SentinelResource" class="headerlink" title="@SentinelResource"></a>@SentinelResource</h3><p>在@SentinelResource注解里，指定blockHandler、fallback、Defaultfallback中的一个，即可进行异常处理。如果都没有，将会向上抛出异常，由springboot定义异常处理机制，此时我们可以编写一个全局异常类对其进行处理。</p>
<p>我们就直接使用blockHandler指定</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SentinelResource(value = &quot;createOrder&quot;,blockHandler = &quot;createOrderFallback&quot;)</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Order <span class="title function_">createOrder</span><span class="params">(Long userId, Long productId)</span> &#123;</span><br><span class="line">    <span class="comment">//Product product = getProductFromRemoteWithLoadBalancerAnnotation(productId);</span></span><br><span class="line">    <span class="comment">//使用Feign代替RESTtemplate完成远程调用</span></span><br><span class="line">    Product product=productFeignClient.getProductById(productId);</span><br><span class="line">    <span class="type">Order</span> <span class="variable">order</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Order</span>();</span><br><span class="line">    order.setId(<span class="number">1L</span>);</span><br><span class="line">    order.setTotalAmount(( product.getPrice().multiply(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(product.getNum()))));</span><br><span class="line">    order.setUserId(userId);</span><br><span class="line">    order.setNickname(<span class="string">&quot;zhangsan&quot;</span>);</span><br><span class="line">    order.setAddress(<span class="string">&quot;ss&quot;</span>);</span><br><span class="line">    order.setProductList(Arrays.asList(product));</span><br><span class="line">    <span class="keyword">return</span> order;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//兜底回调</span></span><br><span class="line"><span class="keyword">public</span> Order <span class="title function_">createOrderFallback</span><span class="params">(Long userId, Long productId, Throwable exception)</span> &#123;</span><br><span class="line">    <span class="type">Order</span> <span class="variable">order</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Order</span>();</span><br><span class="line">    order.setId(<span class="number">0L</span>);</span><br><span class="line">    order.setTotalAmount(BigDecimal.ZERO);</span><br><span class="line">    order.setUserId(userId);</span><br><span class="line">    order.setNickname(<span class="string">&quot;未知用户&quot;</span>);</span><br><span class="line">    order.setAddress(<span class="string">&quot;异常信息：&quot;</span>+exception.getClass());</span><br><span class="line">    <span class="keyword">return</span> order;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在异常时返回：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;totalAmount&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;userId&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;nickname&quot;</span><span class="punctuation">:</span> <span class="string">&quot;未知用户&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;异常信息：class com.alibaba.csp.sentinel.slots.block.flow.FlowException&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;productList&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>：兜底回调方法里异常参数参数一定要定义为Throwable类型</p>
<p><code>public Order createOrderFallback(Long userId, Long productId, Throwable exception) </code></p>
<h3 id="OpenFeign-1"><a href="#OpenFeign-1" class="headerlink" title="OpenFeign"></a>OpenFeign</h3><p>详见OpenFeign的fallback</p>
<h3 id="sphu-entry"><a href="#sphu-entry" class="headerlink" title="sphu.entry"></a>sphu.entry</h3><p><code>SphU</code> 包含了 try-catch 风格的 API。用这种方式，当资源发生了限流之后会抛出 <code>BlockException</code>。这个时候可以捕捉异常，进行限流之后的逻辑处理。示例代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.5.0 版本开始可以利用 try-with-resources 特性（使用有限制）</span></span><br><span class="line"><span class="comment">// 资源名可使用任意有业务语义的字符串，比如方法名、接口名或其它可唯一标识的字符串。</span></span><br><span class="line"><span class="keyword">try</span> (<span class="type">Entry</span> <span class="variable">entry</span> <span class="operator">=</span> SphU.entry(<span class="string">&quot;resourceName&quot;</span>)) &#123;</span><br><span class="line">  <span class="comment">// 被保护的业务逻辑</span></span><br><span class="line">  <span class="comment">// do something here...</span></span><br><span class="line">&#125; <span class="keyword">catch</span> (BlockException ex) &#123;</span><br><span class="line">  <span class="comment">// 资源访问阻止，被限流或被降级</span></span><br><span class="line">  <span class="comment">// 在此处进行相应的处理操作</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="流控规则"><a href="#流控规则" class="headerlink" title="流控规则"></a>流控规则</h2><img src="../assets/屏幕截图 2025-03-30 143428.png" alt="屏幕截图 2025-03-30 143428" style="zoom:75%;" />

<ul>
<li><p>针对来源：表示对何种来源的请求进行限制</p>
</li>
<li><p>阈值类型：QPS（Queries per second）：底层采用计数器的方式统计流量，性能高</p>
<p>​					并发线程数：线程池，性能低，适用于需要线程池的场景</p>
</li>
<li><p>是否集群：单机均摊：比如单机阈值设置为5，开了三个createservice，此模式下最多并发量为15</p>
<p>​					总体阈值：此模式下为5</p>
</li>
</ul>
<h3 id="流控模式："><a href="#流控模式：" class="headerlink" title="流控模式："></a>流控模式：</h3><p>调用关系包括调用方、被调用方；一个方法又可能会调用其它方法，形成一个调用链路的层次关系；有了调用链路的统计信息，我们可以衍生出多种流量控制手段。</p>
<img src="../assets/屏幕截图 2025-03-30 152252.png" alt="屏幕截图 2025-03-30 152252" style="zoom:75%;" />

<p>​		<strong>直接策略：</strong>只对此资源生效</p>
<p>​		<strong>链路策略：</strong>不同的链路不同的策略</p>
<p>​		在配置里配置：<code>spring.cloud.sentinel.web-context-unify= false</code>设置web上下文不统一，表示不统一链路。</p>
<p>​		增加一个链路：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/seckill&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Order <span class="title function_">seckill</span><span class="params">(<span class="meta">@RequestParam(&quot;userId&quot;)</span> Long userId,</span></span><br><span class="line"><span class="params">                         <span class="meta">@RequestParam(&quot;productId&quot;)</span> Long productId)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">Order</span> <span class="variable">order</span> <span class="operator">=</span> orderService.createOrder(userId, productId);</span><br><span class="line">    order.setId(Long.MAX_VALUE);</span><br><span class="line">    <span class="keyword">return</span> order;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​		然后在sentinel中对createOrder进行流控，仅限制通过&#x2F;seckill资源访问createOrder的链路:</p>
<p>​		<img src="../assets/屏幕截图 2025-03-30 153604.png" alt="屏幕截图 2025-03-30 153604" style="zoom:75%;" /></p>
<p>​		这样就做到了对不同链路实现不同的规则</p>
<p>​		<strong>关联策略：</strong></p>
<p>​		举个例子：对数据库进行读写，我们需要写的优先级高，在写的请求量比较大时，才对读进行限流；如果写的请求量小的时候，不对		读进行限流。</p>
<p>​		在controller中加入：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/writeDb&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">writeDb</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;writeDb success&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@GetMapping(&quot;/readDb&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">readDb</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;readDb success&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​		<img src="../assets/屏幕截图 2025-03-30 154457.png" alt="屏幕截图 2025-03-30 154457" style="zoom:75%;" /></p>
<p>那么，在write访问量超出阈值时，readDb无法正常访问，但writeDb本身没受影响。</p>
<h3 id="流控效果"><a href="#流控效果" class="headerlink" title="流控效果"></a>流控效果</h3><p>为了方便测试，引入apipost软件，并在MyBlocKExceptionHandler中添加：<code>httpServletResponse.setStatus(429);//太多请求</code></p>
<ul>
<li><p>直接失败：超过阈值的多余请求直接失败</p>
</li>
<li><p>warmup：随时间逐渐增加可接受的访问量 , 经过预热时长后才达到设置的阈值</p>
</li>
<li><p>排队等待：设置的阈值为每秒放行的请求数量（<strong>匀速</strong>），超出数量的排队等待。还要设置最大等待时长。</p>
<p>Sentinel匀速排队等待策略是Leaky Bucket算法结合虚拟队列等待机制实现的。</p>
</li>
</ul>
<p><strong>注：warmup和排队等待只支持【直接】的流控模式</strong></p>
<p>![屏幕截图 2025-03-31 214742](..&#x2F;assets&#x2F;屏幕截图 2025-03-31 214742.png)</p>
<h2 id="熔断规则"><a href="#熔断规则" class="headerlink" title="熔断规则"></a>熔断规则</h2><h3 id="断路器控制原理"><a href="#断路器控制原理" class="headerlink" title="断路器控制原理"></a>断路器控制原理</h3><p>熔断降级（Circuit Breaker Pattern）是分布式系统中用于提高系统稳定性和容错能力的一种设计模式。它通过监控服务调用的成功率或响应时间，在检测到服务出现异常时，暂时阻止对该服务的进一步调用，从而避免故障扩散和雪崩效应。</p>
<ul>
<li><p>熔断器的工作原理</p>
<p>熔断器的状态通常分为三种：</p>
</li>
</ul>
<ol>
<li><strong>关闭（Closed）</strong>：<ul>
<li>正常情况下，熔断器处于关闭状态，允许请求通过并转发给目标服务。</li>
<li>在此状态下，熔断器会统计失败的请求数量或平均响应时间。</li>
<li>如果在一定时间内失败率达到设定的阈值（例如超过50%的请求失败），则熔断器将切换到打开状态。</li>
</ul>
</li>
<li><strong>打开（Open）</strong>：<ul>
<li>当熔断器处于打开状态时，所有对目标服务的请求都会立即<strong>返回错误</strong>，而不会实际发起请求。</li>
<li>这种快速失败的方式可以减少不必要的等待时间和资源消耗。</li>
<li>经过一段冷却时间（例如30秒）后，熔断器会进入半开状态。</li>
</ul>
</li>
<li><strong>半开（Half-Open）</strong>：<ul>
<li>半开状态是一种试探性的恢复阶段。</li>
<li>在这个状态下，熔断器允许部分请求通过以测试目标服务是否恢复正常。</li>
<li>如果这些请求成功，则熔断器切换回关闭状态；如果仍然失败，则再次切换到打开状态，并重新计时冷却期。</li>
</ul>
</li>
</ol>
<img src="../assets/屏幕截图 2025-03-30 171004.png" alt="屏幕截图 2025-03-30 171004" style="zoom:75%;" />



<h3 id="熔断策略"><a href="#熔断策略" class="headerlink" title="熔断策略"></a>熔断策略</h3><p>远程调用时为了防止product异常对order产生影响，我们在order配置熔断策略</p>
<img src="../assets/屏幕截图 2025-03-30 171621.png" alt="屏幕截图 2025-03-30 171621" style="zoom:75%;" />

<p>最大RT：最大响应时间（response time）</p>
<p>熔断时长：熔断器打开的时长</p>
<p>先说明有熔断和无熔断时远程调用发生异常&#x2F;超时时的区别:</p>
<p>没有熔断规则：每次都会把请求发送出去，超时或错误回调用兜底机制</p>
<p>有熔断规则：远程出问题后，一段时间内直接进行兜底机制</p>
<ul>
<li>慢比例调用</li>
<li>异常比例</li>
<li>异常数</li>
</ul>
<p>![屏幕截图 2025-03-31 214921](..&#x2F;assets&#x2F;屏幕截图 2025-03-31 214921.png)</p>
<h2 id="热点规则"><a href="#热点规则" class="headerlink" title="热点规则"></a>热点规则</h2><p>相当于是更细节的流量控制，除了能对资源进行控制以外，还能精确到参数满足什么规则后进行限制。</p>
<p>热点就可以理解为我们经常要访问的数据</p>
<p>下面进行一个示例进行演示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">需求1：每个用户秒杀 QPS 不得超过 1（秒杀下单 userId 级别）</span><br><span class="line">效果：携带此参数的参与流控，不携带不流控</span><br><span class="line">需求2：6号用户是vvip，不限制QPS（例外情况）</span><br><span class="line">需求3：666号是下架商品，不允许访问</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>：目前 Sentinel 自带的 adapter 仅 Dubbo 方法埋点带了热点参数，其它适配模块（如 Web）默认不支持热点规则，可通过自定义埋点方式指定新的资源名并传入希望的参数。注意自定义埋点的资源名不要和适配模块生成的资源名重复，否则会导致重复统计。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/seckill&quot;)</span></span><br><span class="line"><span class="meta">@SentinelResource(value = &quot;seckill-order&quot;,fallback = &quot;seckillFallback&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Order <span class="title function_">seckill</span><span class="params">(<span class="meta">@RequestParam(&quot;userId&quot;)</span> Long userId,</span></span><br><span class="line"><span class="params">                         <span class="meta">@RequestParam(&quot;productId&quot;)</span> Long productId)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">Order</span> <span class="variable">order</span> <span class="operator">=</span> orderService.createOrder(userId, productId);</span><br><span class="line">    order.setId(Long.MAX_VALUE);</span><br><span class="line">    <span class="keyword">return</span> order;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> Order <span class="title function_">seckillFallback</span><span class="params">(<span class="meta">@RequestParam(&quot;userId&quot;)</span> Long userId,</span></span><br><span class="line"><span class="params">                             <span class="meta">@RequestParam(&quot;productId&quot;)</span> Long productId,</span></span><br><span class="line"><span class="params">                             BlockException exception)</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;seckillFallback....&quot;</span>);</span><br><span class="line">    <span class="type">Order</span> <span class="variable">order</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Order</span>();</span><br><span class="line">    order.setId(productId);</span><br><span class="line">    order.setUserId(userId);</span><br><span class="line">    order.setAddress(<span class="string">&quot;异常信息：&quot;</span>+exception.getMessage());</span><br><span class="line">    <span class="keyword">return</span> order;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>给seckill起名为seckill-order，并启用兜底</p>
<img src="../assets/屏幕截图 2025-03-30 181143.png" alt="屏幕截图 2025-03-30 181143" style="zoom: 67%;" />



<img src="../assets/屏幕截图 2025-03-30 181135.png" alt="屏幕截图 2025-03-30 181135" style="zoom:67%;" />

<p>如上两个热点参数限流，可以实现要求的效果</p>
<p>![屏幕截图 2025-03-31 215016](..&#x2F;assets&#x2F;屏幕截图 2025-03-31 215016.png)</p>
<h2 id="授权规则和系统规则"><a href="#授权规则和系统规则" class="headerlink" title="授权规则和系统规则"></a>授权规则和系统规则</h2><p>参考：<a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/wiki/%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8">https://github.com/alibaba/Sentinel/wiki</a></p>
<p>没什么用</p>
<h2 id="持久化配置"><a href="#持久化配置" class="headerlink" title="持久化配置"></a>持久化配置</h2><p>目前定义的规则都是存储在内存中的，每一次启动项目都需要重新配置规则。</p>
<p>搭配nacos或数据库做规则的持久化</p>
<p>我们以service-order模块下的readDb为例，其在sentinel中的资源名为<code>/readDb</code></p>
<ul>
<li>给本微服务引入依赖：</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.csp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sentinel-datasource-nacos<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>在yml中配置：</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">datasource:</span></span><br><span class="line">      <span class="attr">ds1:</span> <span class="comment"># 数据源名称</span></span><br><span class="line">        <span class="attr">nacos:</span></span><br><span class="line">          <span class="attr">server-addr:</span> <span class="string">localhost:8848</span> <span class="comment"># Nacos 地址</span></span><br><span class="line">          <span class="attr">data-id:</span> <span class="string">service-order</span> <span class="comment"># 流控规则存储的 Data ID</span></span><br><span class="line">          <span class="attr">group-id:</span> <span class="string">DEFAULT_GROUP</span>                     <span class="comment"># Nacos 分组</span></span><br><span class="line">          <span class="attr">data-type:</span> <span class="string">json</span></span><br><span class="line">          <span class="attr">rule-type:</span> <span class="string">flow</span>                             <span class="comment"># 规则类型，这里是流控规则</span></span><br></pre></td></tr></table></figure>

<ol>
<li><strong><code>datasource:</code></strong><ul>
<li>定义了 Sentinel 规则的数据源配置。通过配置不同的数据源，可以实现规则的持久化和动态更新。</li>
</ul>
</li>
<li><strong><code>ds1:</code></strong><ul>
<li>这是一个自定义的数据源名称，你可以根据需要命名。这个名称用于标识不同的数据源配置。如果有多个规则来源（如流控规则、降级规则等），可以通过不同的名字来区分它们。</li>
</ul>
</li>
<li><strong><code>nacos:</code></strong><ul>
<li>指定使用 Nacos 作为规则的持久化存储。这意味着 Sentinel 将从 Nacos 中读取并同步规则。</li>
</ul>
</li>
<li><strong><code>server-addr: 127.0.0.1:8848</code></strong><ul>
<li>Nacos 服务器的地址。这是 Nacos 提供服务的 IP 和端口号。在这个例子中，Nacos 服务运行在本地机器上，监听 8848 端口。</li>
</ul>
</li>
<li><strong><code>data-id: $&#123;spring.application.name&#125;-sentinel</code></strong><ul>
<li><code>data-id</code> 是 Nacos 中的一个唯一标识符，用来指定某个具体的配置文件。<code>$&#123;spring.application.name&#125;</code> 是一个占位符，表示当前 Spring 应用的名称。因此，如果应用的名字是 <code>myapp</code>，那么完整的 <code>data-id</code> 就会是 <code>myapp-sentinel</code>。这样做的好处是可以为不同的应用提供独立的规则配置。</li>
</ul>
</li>
<li><strong><code>group-id: DEFAULT_GROUP</code></strong><ul>
<li><code>group-id</code> 在 Nacos 中用于组织配置。它可以将多个 <code>data-id</code> 归类在一起，便于管理和查找。这里设置为 <code>DEFAULT_GROUP</code> 表示使用默认分组。</li>
</ul>
</li>
<li><strong><code>rule-type: flow</code></strong><ul>
<li>指定了规则的类型。在这个例子中，<code>flow</code> 表示这是一个流控规则（即限流规则）。Sentinel 支持多种类型的规则，包括流控规则、降级规则、系统规则等。通过设置不同的 <code>rule-type</code>，可以从 Nacos 加载相应类型的规则。</li>
</ul>
</li>
</ol>
<p>工作原理:</p>
<p>当你配置了上述内容后，Sentinel 会按照以下步骤工作：</p>
<ol>
<li><strong>初始化</strong>：当你的应用启动时，Sentinel 会根据配置尝试连接到指定的 Nacos 服务器 (<code>server-addr</code>)。</li>
<li><strong>加载规则</strong>：Sentinel 会从 Nacos 中读取与 <code>data-id</code> 和 <code>group-id</code> 匹配的配置文件，并将其转换为相应的规则（在这个例子中是流控规则）。</li>
<li><strong>应用规则</strong>：读取到的规则会被应用到 Sentinel 中，从而控制流量、保护资源。</li>
<li><strong>动态更新</strong>：如果 Nacos 中的相关配置发生变化，Sentinel 可以自动检测到这些变化，并实时更新其内部的规则，而无需重启应用。</li>
</ol>
<ul>
<li><p>在nacos对应namespace的对应group中创建配置（采用json格式）</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;resource&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/readDb&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;limitApp&quot;</span><span class="punctuation">:</span> <span class="string">&quot;default&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">    <span class="attr">&quot;grade&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span>  </span><br><span class="line">    <span class="attr">&quot;count&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span>	 </span><br><span class="line">    <span class="attr">&quot;strategy&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span>  </span><br><span class="line">    <span class="attr">&quot;controlBehavior&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;clusterMode&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span>  </span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="Gateway"><a href="#Gateway" class="headerlink" title="Gateway"></a>Gateway</h1><img src="../assets/屏幕截图 2025-03-30 191357.png" alt="屏幕截图 2025-03-30 191357" style="zoom:67%;" />

<p>作为系统的入口点，它负责接收所有的客户端请求，并将这些请求路由到后端的适当微服务。</p>
<h2 id="创建网关"><a href="#创建网关" class="headerlink" title="创建网关"></a>创建网关</h2><p>在cloud-demo下新建gateway模块(maven管理的java项目)</p>
<p>引入依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-loadbalancer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>进行基础配置：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gateway</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<p>编写主程序:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GatewayMainApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(GatewayMainApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h2><h3 id="规则配置"><a href="#规则配置" class="headerlink" title="规则配置"></a>规则配置</h3><p>需求：</p>
<img src="../assets/屏幕截图 2025-03-30 224646.png" alt="屏幕截图 2025-03-30 224646" style="zoom:75%;" />



<p>cloud提供了两种方式配置路由规则：</p>
<ul>
<li><p>第一种：用配置文件配置路由规则</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> String id;</span><br><span class="line"><span class="keyword">private</span> <span class="meta">@NotEmpty</span> <span class="meta">@Valid</span> List&lt;PredicateDefinition&gt; predicates = <span class="keyword">new</span> <span class="title class_">ArrayList</span>();</span><br><span class="line"><span class="keyword">private</span> <span class="meta">@Valid</span> List&lt;FilterDefinition&gt; filters = <span class="keyword">new</span> <span class="title class_">ArrayList</span>();</span><br><span class="line"><span class="keyword">private</span> <span class="meta">@NotNull</span> URI uri;</span><br><span class="line"><span class="keyword">private</span> Map&lt;String, Object&gt; metadata = <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="variable">order</span> <span class="operator">=</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure>

<p>以上是spring.cloud.gateway.routes的配置项</p>
<p>我们进行较为简单的配置：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">order-route</span> <span class="comment">#路由名字</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://service-order</span> <span class="comment">#lb：负载均衡。</span></span><br><span class="line">          <span class="attr">predicates:</span> <span class="comment">#断言，指定遵守哪种规则就转给订单</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/api/order/**</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">product-route</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://service-product</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/api/product/**</span></span><br></pre></td></tr></table></figure>

<p><strong>此外</strong>，我们还需要给controller和feign添加<strong>在gateway配置中设置的基准路径</strong>（feign是加上远程调用的目标的基准路径）</p>
<p>在controller上：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/api/order&quot;)</span></span><br></pre></td></tr></table></figure>

<p>在feign上：（不允许标注@RequestMapping在feign上，所以我们给具体方法前面加上远程调用的目标的基准路径）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/api/product/product/&#123;id&#125;&quot;)</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h3><img src="../assets/屏幕截图 2025-03-30 232352.png" alt="屏幕截图 2025-03-30 232352" style="zoom:75%;" />

<p>其中断言是从上往下进行匹配的，上面的匹配上了，就不会再继续向下匹配。但是还有一个order配置参数，用来指定断言匹配的顺序。</p>
<p>还有一个metadata配置参数，用来配置个人配置</p>
<p>在接下来，我们看一下如何使用filter配置参数，以及断言除了Path外的其他指定。</p>
<h2 id="断言"><a href="#断言" class="headerlink" title="断言"></a>断言</h2><h3 id="断言的使用"><a href="#断言的使用" class="headerlink" title="断言的使用"></a>断言的使用</h3><p>所有断言：</p>
<p>参考spring官方文档<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-cloud-gateway/reference/spring-cloud-gateway/request-predicates-factories.html">Route Predicate Factories :: Spring Cloud Gateway</a></p>
<p>也可以查看RoutePredicateFactory接口下AbstractRoutePredicateFactory抽象类的实现类，断言的参数名就是这些实现类名去掉后面的RoutePredicateFactory后缀。而这些实现类的args可以参考他们的构造器中的config中定义的参数来写。</p>
<p>先介绍以下断言的短写法和长写法：以Path为例</p>
<p>短写法：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">predicates:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Path=/api/product/**</span></span><br></pre></td></tr></table></figure>

<p>长写法：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">predicates:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Path</span></span><br><span class="line">    <span class="attr">args:</span></span><br><span class="line">      <span class="attr">patterns:</span> <span class="string">/api/product/**</span></span><br><span class="line">      <span class="attr">matchTrailingSlash:</span> <span class="literal">true</span> <span class="comment">#表示/api/和/api是一个路径</span></span><br></pre></td></tr></table></figure>



<img src="../assets/屏幕截图 2025-03-31 085727.png" alt="屏幕截图 2025-03-31 085727" style="zoom:75%;" />

<p>下面以Query为例演示：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">id:</span> <span class="string">bing-route</span></span><br><span class="line">  <span class="attr">uri:</span> <span class="string">https://cn.bing.com/</span></span><br><span class="line">  <span class="attr">predicates:</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Path</span></span><br><span class="line">      <span class="attr">args:</span> </span><br><span class="line">        <span class="attr">patterns:</span> <span class="string">/search</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Query</span></span><br><span class="line">      <span class="attr">args:</span></span><br><span class="line">        <span class="attr">param:</span> <span class="string">q</span></span><br><span class="line">        <span class="attr">regexp:</span> <span class="string">haha</span></span><br></pre></td></tr></table></figure>

<p>因为我们给网关指定了80端口，所以接下来我们在访问<code>localhost/search?q=haha</code>的时候相当于在bing里搜索了haha。</p>
<h3 id="自定义断言工厂"><a href="#自定义断言工厂" class="headerlink" title="自定义断言工厂"></a>自定义断言工厂</h3><p>比如:</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">id:</span> <span class="string">bing-route</span></span><br><span class="line">  <span class="attr">uri:</span> <span class="string">https://cn.bing.com/</span></span><br><span class="line">  <span class="attr">predicates:</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Path</span></span><br><span class="line">      <span class="attr">args:</span> </span><br><span class="line">        <span class="attr">patterns:</span> <span class="string">/search</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Query</span></span><br><span class="line">      <span class="attr">args:</span></span><br><span class="line">        <span class="attr">param:</span> <span class="string">q</span></span><br><span class="line">        <span class="attr">regexp:</span> <span class="string">haha</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Vip=user,muite</span></span><br><span class="line">    <span class="string">(-</span> <span class="attr">name:</span> <span class="string">Vip</span></span><br><span class="line">      <span class="attr">args:</span></span><br><span class="line">        <span class="attr">param:</span> <span class="string">user</span></span><br><span class="line">        <span class="attr">value:</span> <span class="string">muite)</span></span><br></pre></td></tr></table></figure>

<p>需求是只有携带参数中的用户名为muite（VIP用户）才转发到搜索，其他人不转发。</p>
<p>实现：</p>
<p>参考已实现的断言工厂类，这里参考QueryRoutePredicateFactory</p>
<p>在gateway模块下新建predicate包，创建VipRoutePredicateFactory继承AbstractRoutePredicateFactory:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//别忘了放进容器中</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VipRoutePredicateFactory</span> <span class="keyword">extends</span> <span class="title class_">AbstractRoutePredicateFactory</span>&lt;VipRoutePredicateFactory.Config&gt; &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">VipRoutePredicateFactory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(Config.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//对请求是否满足断言要求进行判断</span></span><br><span class="line">    <span class="comment">//localhost:/search?q=haha&amp;user=muite满足要求</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Predicate&lt;ServerWebExchange&gt; <span class="title function_">apply</span><span class="params">(Config config)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">GatewayPredicate</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">test</span><span class="params">(ServerWebExchange serverWebExchange)</span> &#123;</span><br><span class="line">                <span class="comment">//获取当前请求</span></span><br><span class="line">                <span class="type">ServerHttpRequest</span> <span class="variable">request</span> <span class="operator">=</span> serverWebExchange.getRequest();</span><br><span class="line">                <span class="comment">//拿到参数</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">first</span> <span class="operator">=</span> request.getQueryParams().getFirst(config.param);</span><br><span class="line">                <span class="comment">//使用StringUtils工具判断参数值是否符合规则</span></span><br><span class="line">                <span class="keyword">return</span> StringUtils.hasText(first)&amp;&amp;first.equals(config.value);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//指定短写法中参数值书写的前后顺序</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;String&gt; <span class="title function_">shortcutFieldOrder</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> Arrays.asList(<span class="string">&quot;param&quot;</span>,<span class="string">&quot;value&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * config代表可以配置的参数</span></span><br><span class="line"><span class="comment">    * */</span></span><br><span class="line">    <span class="meta">@Validated</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Config</span> &#123;</span><br><span class="line">        <span class="meta">@NotEmpty</span></span><br><span class="line">        <span class="keyword">private</span> String param;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@NotEmpty</span></span><br><span class="line">        <span class="keyword">private</span> String value;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="meta">@NotEmpty</span> String <span class="title function_">getParam</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> param;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setParam</span><span class="params">(<span class="meta">@NotEmpty</span> String param)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.param = param;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="meta">@NotEmpty</span> String <span class="title function_">getValue</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> value;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(<span class="meta">@NotEmpty</span> String value)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.value = value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="过滤器"><a href="#过滤器" class="headerlink" title="过滤器"></a>过滤器</h2><p>参考<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-cloud-gateway/reference/spring-cloud-gateway/gatewayfilter-factories.html">GatewayFilter Factories :: Spring Cloud Gateway</a></p>
<img src="../assets/屏幕截图 2025-03-31 112004.png" alt="屏幕截图 2025-03-31 112004" style="zoom:75%;" />



<h3 id="基本实现"><a href="#基本实现" class="headerlink" title="基本实现"></a>基本实现</h3><p>以RewritePathGateFilterFactory为例</p>
<p>在以前，我们想要通过网关发送请求，网关会照抄不误的把前端提交的地址交给目的地。详见此笔记的<code>Gateway--路由--规则配置</code> 中我们给controller和feign做的路径修改。</p>
<p>所以我们通过RewritePathGateFilterFactory实现如下效果:</p>
<img src="../assets/屏幕截图 2025-03-31 112734.png" alt="屏幕截图 2025-03-31 112734" style="zoom:75%;" />



<p>想要实现这个功能我们就给网关添加filter</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">filters:</span> <span class="comment">#利用正则表达式将形如/api/order/...变为/...</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">RewritePath=/api/order/?(?&lt;segment&gt;.*),</span> <span class="string">/$\&#123;segment&#125;</span></span><br></pre></td></tr></table></figure>

<p>完毕</p>
<h3 id="默认filter"><a href="#默认filter" class="headerlink" title="默认filter"></a>默认filter</h3><p>上面的filter‘仅仅是给order进行配置的，如果product需要，还需要另行配置。</p>
<p>springcloud还有一个默认filter</p>
<p>配置如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      default-filters:</span><br><span class="line">        - 具体filter</span><br></pre></td></tr></table></figure>

<p>这是给所有路由都进行的filter配置</p>
<h3 id="全局filter"><a href="#全局filter" class="headerlink" title="全局filter"></a>全局filter</h3><p>我们来自定义一个可以应用于所有路由的RtGlobalFilter，用来记录请求耗时（响应时间）</p>
<p>全局filter不需要在配置文件中进行配置，而是直接将组件放入容器中</p>
<p>在网关模块下新建filter.RtGlobalFilter</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RtGlobalFilter</span> <span class="keyword">implements</span> <span class="title class_">GlobalFilter</span>, Ordered&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> &#123;</span><br><span class="line">        <span class="type">ServerHttpRequest</span> <span class="variable">request</span> <span class="operator">=</span> exchange.getRequest();</span><br><span class="line">        <span class="type">ServerHttpResponse</span> <span class="variable">response</span> <span class="operator">=</span> exchange.getResponse();</span><br><span class="line">        String uri=request.getURI().toString();</span><br><span class="line">        <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        log.info(<span class="string">&quot;请求【&#123;&#125;】开始:时间：&#123;&#125;&quot;</span>,uri,start);</span><br><span class="line">        <span class="comment">//================以上是前者逻辑=================</span></span><br><span class="line">        Mono&lt;Void&gt; filter = chain.filter(exchange)</span><br><span class="line">                .doFinally((result)-&gt;&#123;</span><br><span class="line">                    <span class="comment">//=================以下是后置逻辑=================</span></span><br><span class="line">                    <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">                    log.info(<span class="string">&quot;请求【&#123;&#125;】结束：时间：&#123;&#125;,耗时：&#123;&#125;ms&quot;</span>,uri,end,end-start);</span><br><span class="line">                &#125;);<span class="comment">//放行</span></span><br><span class="line">        <span class="comment">//因为响应式编程是全异步处理，</span></span><br><span class="line">        <span class="comment">//所以直接在这下面写的代码并不是等目标方法执行结束后执行的</span></span><br><span class="line">        <span class="comment">//所以并不能称之为后置逻辑，后置逻辑可以用上面的链式编程实现</span></span><br><span class="line">        <span class="keyword">return</span> filter;</span><br><span class="line">        <span class="comment">//return filter 表示当前过滤器已经完成其职责，</span></span><br><span class="line">        <span class="comment">// 并将控制权交还给网关框架，让框架继续处理后续的逻辑（下一个过滤器或目标操作）。</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//设置执行顺序</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getOrder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="自定义过滤器工厂"><a href="#自定义过滤器工厂" class="headerlink" title="自定义过滤器工厂"></a>自定义过滤器工厂</h3><p>举例：<br>需求：</p>
<p>每一个请求发出后，添加一个自定义的响应头，这个响应头是一个一次性令牌（uuid或JWT），但是也不是每一个路由都需要这个过滤器，这时候我们就可以自定义一个过滤器工厂。</p>
<p>参考AddResponseHeaderGatewayFilterFactory过滤器工厂我们来实现自定义工厂：</p>
<p>继承AbstractNameValueGatewayFilterFactory并进行重写</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">//每次响应之前，添加一个一次性令牌,支持uuid，jwt等各种格式</span><br><span class="line">//我们想要响应头名为X-Response-Token，响应体为不同形式的令牌</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OnceTokenGatewayFilterFactory</span> <span class="keyword">extends</span> <span class="title class_">AbstractNameValueGatewayFilterFactory</span> &#123;</span><br><span class="line">    <span class="comment">//这里的config是获取了我们在配置文件中配置的key和value</span></span><br><span class="line">    <span class="comment">//apply 方法是核心方法，用于创建实际的过滤器实例。</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> GatewayFilter <span class="title function_">apply</span><span class="params">(NameValueConfig config)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">GatewayFilter</span>() &#123;</span><br><span class="line">            <span class="comment">//filter 方法是过滤器的核心逻辑，用于处理请求和响应。</span></span><br><span class="line">            <span class="comment">//参数 exchange 表示当前的 HTTP 请求和响应上下文。</span></span><br><span class="line">            <span class="comment">//参数 chain 表示过滤器链，用于将请求传递到下一个过滤器或目标服务。</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> &#123;</span><br><span class="line">                <span class="comment">//chain.filter(exchange):将请求放行到下一个过滤器或目标服务进行处理。</span></span><br><span class="line">                <span class="comment">//返回的是一个 Mono&lt;Void&gt;，表示异步操作流。</span></span><br><span class="line">                <span class="comment">//.then(Mono.fromRunnable(...)): .then 是响应式编程中的一个操作符，用于在前一个操作完成后执行后续操作。</span></span><br><span class="line">                 <span class="comment">//Mono.fromRunnable 用于封装一个没有返回值的操作（即副作用操作），在这里用来修改响应头。</span></span><br><span class="line">                <span class="keyword">return</span> chain.filter(exchange).then(Mono.fromRunnable(()-&gt;&#123;</span><br><span class="line">                    <span class="type">ServerHttpResponse</span> <span class="variable">response</span> <span class="operator">=</span> exchange.getResponse();</span><br><span class="line">                    <span class="type">HttpHeaders</span> <span class="variable">headers</span> <span class="operator">=</span> response.getHeaders();</span><br><span class="line">                    String value=config.getValue();</span><br><span class="line">                    <span class="keyword">if</span>(<span class="string">&quot;uuid&quot;</span>.equalsIgnoreCase(value))&#123;</span><br><span class="line">                        value= UUID.randomUUID().toString();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span>(<span class="string">&quot;jwt&quot;</span>.equalsIgnoreCase(value))&#123;</span><br><span class="line">                        <span class="comment">//应该用代码生成jwt，这里只作功能演示</span></span><br><span class="line">                        			                                                  value=<span class="string">&quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWUsImlhdCI6MTUxNjIzOTAyMn0.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c&quot;</span>;</span><br><span class="line">                                           </span><br><span class="line">                    &#125;</span><br><span class="line">                    headers.add(config.getName(),value);</span><br><span class="line">                &#125;));</span><br><span class="line">                <span class="comment">//最终，chain.filter(exchange) 处理完成，并通过 .then 执行后置逻辑（添加响应头）。</span></span><br><span class="line">                <span class="comment">//整个过滤器的执行结果以 Mono&lt;Void&gt; 的形式返回，表示异步操作完成。</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>跟断言工厂一样，filter名也是去掉后面的GatewayFilterFactory</p>
<h3 id="全局跨域"><a href="#全局跨域" class="headerlink" title="全局跨域"></a>全局跨域</h3><p><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-cloud-gateway/reference/spring-cloud-gateway/cors-configuration.html">CORS Configuration :: Spring Cloud Gateway</a></p>
<p>在前后分离的开发模式下，前端给后端发送请求，经常会出现跨域问题，之前我们是通过@CrossOrigin解决的。</p>
<p>而内置的CorsFilter只能在本微服务下实现跨域</p>
<p>我们可以在网关设置统一跨域</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">globalcors:</span></span><br><span class="line">        <span class="attr">cors-configurations:</span></span><br><span class="line">          <span class="string">&#x27;[/**]&#x27;</span><span class="string">:</span> <span class="comment">#对所有请求进行配置</span></span><br><span class="line">            <span class="comment"># 定义允许访问资源的来源（Origin）。Origin 是指发起请求的客户端地址，例如 http://localhost:3000。</span></span><br><span class="line">            <span class="attr">allowed-origin-patterns:</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">            <span class="comment">#允许的 HTTP 头信息</span></span><br><span class="line">            <span class="attr">allowed-headers:</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">            <span class="comment">#允许的 HTTP 请求方法</span></span><br><span class="line">            <span class="attr">allowed-methods:</span> <span class="string">&#x27;*&#x27;</span></span><br></pre></td></tr></table></figure>





<p>除了全局跨域，还支持只设置在某一个路由下允许跨域：</p>
<p>这是官方文档示例：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">cors_route</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">https://example.org</span></span><br><span class="line">        <span class="attr">predicates:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">Path=/service/**</span></span><br><span class="line">        <span class="attr">metadata:</span></span><br><span class="line">          <span class="attr">cors:</span></span><br><span class="line">            <span class="attr">allowedOrigins:</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">            <span class="attr">allowedMethods:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">GET</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">POST</span></span><br><span class="line">            <span class="attr">allowedHeaders:</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line">            <span class="attr">maxAge:</span> <span class="number">30</span></span><br></pre></td></tr></table></figure>



<h3 id="思考-2"><a href="#思考-2" class="headerlink" title="思考"></a>思考</h3><p>微服务之间的调用经过网关吗？</p>
<p>以上的示例都是不经过网关的，一个微服务去注册中心获取另一个微服务的地址，然后直接进行远程调用。</p>
<p>想要经过网关也可以，在上面的例子中，将ProductFignCLient的@FeignClient注解中的value改为网关的服务名；并在方法的Mapping的路径中加上目标微服务的基准路径（比如&#x2F;api&#x2F;product）</p>
<p><strong>但是，网关是用来和前端进行对接的，后端的微服务之间互相调用不需要经过网关。</strong></p>
<h1 id="Seata"><a href="#Seata" class="headerlink" title="Seata"></a>Seata</h1><img src="../assets/屏幕截图 2025-03-31 174553.png" alt="屏幕截图 2025-03-31 174553" style="zoom: 50%;" />

<p>分布式事务的产生原因：</p>
<p>举个例子，在JDBC中，我们会对事务进行commit和rollback的控制，但这种控制仅限于一条连接中执行的逻辑。</p>
<p>当我们需要购买商品时，购买的操作可能涉及不同的微服务，每个微服务的数据源又可能是不一样的，这就会出现一个问题：比如当我的账户操作出现异常时，订单和库存由于和账户不在一条连接中，所以它们二者可能已经完成了提交，没办法和账户进行统一的comiit或rollback操作。</p>
<p>Seata就提供了在分布式系统下保证多个数据库一起提交回滚，从而达到数据一致性状态的一站式解决方案。</p>
<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><img src="../assets/屏幕截图 2025-03-31 175109.png" alt="屏幕截图 2025-03-31 175109"  />

<p>每一个微服务事务和全局事务启动时，都要向TC去注册自己的事务，而且每一个事务的状态也要汇报给TC。</p>
<p>如果某一个事务出现问题，TC会要求这个事务进行回滚，而且也会根据情况要求其他事务的回滚。</p>
<h2 id="整合Seata"><a href="#整合Seata" class="headerlink" title="整合Seata"></a>整合Seata</h2><p>首先要启动seata服务器（TC），然后给每个微服务引入seata的客户端</p>
<p>启动seata服务器：</p>
<p>进入seata的bin目录打开cmd，执行<code>seata-server.bat</code>命令</p>
<p>其中7091端口是seata dashboard；8091端口是默认用于 Seata Server 的 gRPC 通信端口，是 TM（事务管理器）和 RM（资源管理器）与 TC（事务协调器）之间通信的关键端口。</p>
<p>在每个微服务中引入seata客户端：</p>
<p>也就是引入seata依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-seata<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2023.0.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>除此之外，还要让每个微服务连接上seata服务器</p>
<p>所以在每个微服务的resources下创建file.conf ，在其中添加简单配置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">service &#123;</span><br><span class="line">  #transaction service group mapping</span><br><span class="line">  vgroupMapping.default_tx_group = &quot;default&quot;</span><br><span class="line">  #only support when registry.type=file, please don&#x27;t set multiple addresses</span><br><span class="line">  default.grouplist = &quot;127.0.0.1:8091&quot;</span><br><span class="line">  #degrade, current not support</span><br><span class="line">  enableDegrade = false</span><br><span class="line">  #disable seata</span><br><span class="line">  disableGlobalTransaction = false</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>然而此时我们发现全局事务的回滚还是没有实现，因为我们还需要在TM（上图的事务管理器）的serviceimpl中的方法上标注<code>@GlobalTransaction</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">虽然 `@GlobalTransactional` 可以在技术层面上标注在任何 Spring 管理的 Bean 的方法上，但最佳实践建议将其应用在服务层（Service Layer），即 Service 实现类的方法上，而不是 Controller 层。这是因为：按照典型的分层架构（Controller -&gt; Service -&gt; Repository），Controller 层主要负责接收请求和返回响应，而具体的业务逻辑应该封装在 Service 层。因此，涉及事务管理的操作更适合放在 Service 层实现。</span><br></pre></td></tr></table></figure>





<h2 id="原理-1"><a href="#原理-1" class="headerlink" title="原理"></a>原理</h2><h3 id="二阶提交协议流程"><a href="#二阶提交协议流程" class="headerlink" title="二阶提交协议流程"></a>二阶提交协议流程</h3><p>![SpringCloud-第 2 页.drawio](..&#x2F;assets&#x2F;SpringCloud-第 2 页.drawio.png)</p>
<img src="../assets/屏幕截图 2025-03-31 190657.png" alt="屏幕截图 2025-03-31 190657" style="zoom:67%;" />

<img src="../assets/屏幕截图 2025-03-31 190705.png" alt="屏幕截图 2025-03-31 190705" style="zoom: 67%;" />



<h3 id="四种事务模式"><a href="#四种事务模式" class="headerlink" title="四种事务模式"></a>四种事务模式</h3><p>AT: 上面的模式（推荐的模式），性能高于XA</p>
<p>TCC：也是二阶提交协议，全部要手动编写代码，第一阶段定义本地应该做什么；第二阶段定义发生异常怎么做，如何回滚。和成功了怎么做，如何提交。  所以一般适用于广义事务（不局限于数据库事务）的二阶提交处理</p>
<p>Saga：整合消息队列来做事务的最终一致性。</p>
<p>XA：也是二阶提交协议，但是是数据库原生支持的，效率较差，一般不用。</p>
<ul>
<li><strong>AT 模式</strong>：适用于大多数情况，特别是当希望最小化对现有业务代码的影响时。</li>
<li><strong>TCC 模式</strong>：适用于需要精确控制事务流程且可以接受一定复杂度增加的场景。</li>
<li><strong>Saga 模式</strong>：适用于长时间运行的服务调用或需要处理复杂业务流程的场景。</li>
<li><strong>XA 模式</strong>：适用于对数据一致性要求极高且能够接受较低性能的场景。</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="https://mutesniper.github.io">Muite</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="https://mutesniper.github.io/2025/04/19/springCloudAlibaba/">https://mutesniper.github.io/2025/04/19/springCloudAlibaba/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles on this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless otherwise stated.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/note/">note</a><a class="post-meta__tags" href="/tags/Microservices/">Microservices</a></div><div class="post-share"><div class="social-share" data-image="https://img.alicdn.com/bao/uploaded/i3/2200690044395/O1CN012NL22Q1iKxHYWb17f_!!2200690044395.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2025/04/19/linux/" title="笔记-Linux"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">Previous</div><div class="info-item-2">笔记-Linux</div></div><div class="info-2"><div class="info-item-1">初识linuxLinux内核linux系统的组成如下：  Linux系统内核  系统级应用程序  内核提供系统最核心的功能，如：调度CPU、调度内存、调度文件系统、调度网络通讯、调度IO等。  系统级应用程序，可以理解为出厂自带程序，可供用户快速上手操作系统，如：文件管理器、任务管理器、图片查看、音乐播放       虚拟机  虚拟机快照通过快照可以实现虚拟机状态回滚。 虚拟机的克隆右键虚拟机–管理–克隆 可以在本机克隆，也可以克隆到另一台计算机上 虚拟机的迁移删除虚拟系统安装好了，它的本质就是文件，因此迁移和删除很方便，直接对文件夹进行操作就行了。 Linux基础命令Linux的目录结构Linux的目录结构是一个属性结构。Linux没有盘符的概念，只有一个根目录**&#x2F;**...</div></div></div></a><a class="pagination-related" href="/2025/04/19/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" title=""><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">Next</div><div class="info-item-2"></div></div><div class="info-2"><div class="info-item-1">设计原则单一职责原则一个类只负责一项职责 ；类中方法足够少时，可以让一个方法只负责一项职责 接口隔离原则客户端不应该依赖它不需要的接口，即一个类对另一个类的依赖应该建立在最小的接口上 错误做法：   改进： ![屏幕截图 2025-03-20 085318](..&#x2F;assets&#x2F;屏幕截图 2025-03-20...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2025/04/19/String/" title="笔记-String"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-19</div><div class="info-item-2">笔记-String</div></div><div class="info-2"><div class="info-item-1">String:特性： 内容不会发生改变，它的对象在创建后不能被更改。如果进行修改则会创建一个新的字符串变量。 由于String对象不可变，所以它是线程安全的。  创建方法： 直接赋值： 1String name=&quot;... &quot;;  构造方法： 1234public String()public String(String original)public String(char[] chs)public String (byte[] chs)  方法： 获取长度：1str.length() 查找子串:1234//返回第一个指定字串的索引str.indexOf...</div></div></div></a><a class="pagination-related" href="/2025/04/19/MyBatis/" title="笔记-MyBatis"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-19</div><div class="info-item-2">笔记-MyBatis</div></div><div class="info-2"><div class="info-item-1">简介MyBatis是持久层框架（和数据库进行交互的框架） MyBatis 不像 Hibernete 等这些全自动框架，它把关键的SQL部分交给程序员自己编写，而不是自动生成  HelloWorld步骤：  导入mybatis依赖  配置数据源  编写javabean对应数据库一个表模型  以前：Dao接口–&gt;Dao实现  。–&gt;标注@Repository注解 现在：Mapper接口–&gt;Mapper.xml实现 ,–&gt;标注@Mapper注解 （安装mybatisx插件自动为mapper类生成mapper文件，我们只需要在mapper文件中配置方法的sql语句）  告诉mybatis去哪里找mapper文件：mybatis.mapper-locations=classpath:mapper/**.xml   mapper接口： 1234@Mapper //告诉spring，这是MyBatis操作数据库用的接口public interface EmpMapper &#123;    Emp getEmpById(Integer...</div></div></div></a><a class="pagination-related" href="/2025/03/17/maven%E5%9F%BA%E7%A1%80/" title="JAVA学习笔记-maven基础"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-03-17</div><div class="info-item-2">JAVA学习笔记-maven基础</div></div><div class="info-2"><div class="info-item-1">简介在了解Maven之前，我们先来看看一个Java项目需要的东西。首先，我们需要确定引入哪些依赖包。例如，如果我们需要用到commons logging，我们就必须把commons...</div></div></div></a><a class="pagination-related" href="/2025/04/19/git/" title="笔记-git"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-19</div><div class="info-item-2">笔记-git</div></div><div class="info-2"><div class="info-item-1">简介Git: 一个分布式版本控制系统 集中式vs分布式：  集中式: 版本库集中存放在中央服务器，使用时，从中央服务器获取最新的版本，修改完后，再推送给中央服务器。且集中式版本控制系统必须联网才能工作，不方便。 分布式：每个人的电脑都有一个完整的版本库，所以工作时不需要联网。将仓库进行同步就可以完成多人协作，但其实并不常用这种方法，而是通过一台充当“中央服务器”的电脑来方便“交换”大家的修改，没有它大家也一样干活，只是交换修改不方便而已。  Git安装Linux 下安装输入git,查看是否已经安装Git: 123$ gitThe program &#x27;git&#x27; is currently not installed. You can install it by typing:sudo apt-get install git  像上面的命令，有很多Linux会友好地告诉你Git没有安装，还会告诉你如何安装Git。 如果碰巧用Debian或Ubuntu Linux，通过一条sudo apt-get install...</div></div></div></a><a class="pagination-related" href="/2025/04/19/springboot/" title=""><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-19</div><div class="info-item-2"></div></div><div class="info-2"><div class="info-item-1">简介SpringBoot 帮我们简单、快速地创建一个独立的、生产级别的 Spring 应用； 特性：  快速创建独立 Spring 应用  直接嵌入Tomcat、Jetty or Undertow  提供可选的 starter，简化应用整合  按需自动配置 Spring 以及 第三方库  提供生产级特性：如 监控指标、健康检查、外部化配置等  无代码生成、无xml； 都是基于自动配置技术   场景启动器SpringBoot场景启动器：官方写的启动器命名：spring-boot-starter-*。第三方启动器命名：*-spring-boot-starter ​	作用：场景启动器负责把当前场景需要用的jar包都导入进来 ​	每个场景启动器都有一个基础依赖：spring-boot-starter 依赖管理为什么项目依赖不需要写版本号？—maven父子继承，父项目可以锁定版本。 父项目不管理的包都需要添加版本号 *自动配置基本理解 自动配置 导入场景，容器中就会自动配置好这个场景的核心组件。如 Tomcat、SpringMVC、DataSource...</div></div></div></a><a class="pagination-related" href="/2025/04/19/spring/" title=""><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-19</div><div class="info-item-2"></div></div><div class="info-2"><div class="info-item-1">简介spring是一个IoC和AOP框架 Spring的特性：  非侵入式：基于Spring开发的应用中的对象可以不依赖于Spring的API 依赖注入：DI（Dependency Injection）是反转控制（IoC：Inversion of Control）最经典的实现 面向切面编程：Aspect Oriented Programming ...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="https://img.alicdn.com/bao/uploaded/i3/2200690044395/O1CN012NL22Q1iKxHYWb17f_!!2200690044395.jpg" onerror="this.onerror=null;this.src='/null'" alt="avatar"/></div><div class="author-info-name">Muite</div><div class="author-info-description">keep learning</div><div class="site-data"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">23</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">12</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">3</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/mutesniper"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/mutesniper" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.</span> <span class="toc-text">微服务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9F"><span class="toc-number">1.1.</span> <span class="toc-text">什么是微服务？</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%9A%84%E4%B8%BB%E8%A6%81%E7%89%B9%E7%82%B9"><span class="toc-number">1.1.1.</span> <span class="toc-text">微服务的主要特点</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BD%BF%E7%94%A8%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9F"><span class="toc-number">1.2.</span> <span class="toc-text">为什么使用微服务？</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E5%9F%BA%E7%A1%80"><span class="toc-number"></span> <span class="toc-text">分布式基础</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%95%E4%BD%93%E6%9E%B6%E6%9E%84"><span class="toc-number">1.</span> <span class="toc-text">单体架构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E6%9E%B6%E6%9E%84"><span class="toc-number">2.</span> <span class="toc-text">集群架构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84"><span class="toc-number">3.</span> <span class="toc-text">分布式架构</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Nacos"><span class="toc-number"></span> <span class="toc-text">Nacos</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83"><span class="toc-number">1.</span> <span class="toc-text">注册中心</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C"><span class="toc-number">1.1.</span> <span class="toc-text">服务注册</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0"><span class="toc-number">1.2.</span> <span class="toc-text">服务发现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E5%BE%AE%E6%9C%8D%E5%8A%A1API"><span class="toc-number">1.3.</span> <span class="toc-text">编写微服务API</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1API"><span class="toc-number">1.3.1.</span> <span class="toc-text">负载均衡API</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%9D%E8%80%83"><span class="toc-number">1.3.2.</span> <span class="toc-text">思考</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83"><span class="toc-number">2.</span> <span class="toc-text">配置中心</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8"><span class="toc-number">2.1.</span> <span class="toc-text">基本使用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E5%88%B7%E6%96%B0"><span class="toc-number">2.1.1.</span> <span class="toc-text">动态刷新</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E7%9B%91%E5%90%AC"><span class="toc-number">2.1.2.</span> <span class="toc-text">配置监听</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%9D%E8%80%83-1"><span class="toc-number">2.1.3.</span> <span class="toc-text">思考</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E9%9A%94%E7%A6%BB"><span class="toc-number">2.2.</span> <span class="toc-text">数据隔离</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">3.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#OpenFeign"><span class="toc-number"></span> <span class="toc-text">*OpenFeign</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8"><span class="toc-number">1.</span> <span class="toc-text">远程调用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A3%B0%E6%98%8E%E5%BC%8F%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.1.</span> <span class="toc-text">声明式实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E6%96%B9API"><span class="toc-number">1.2.</span> <span class="toc-text">第三方API</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%8F%E6%8A%80%E5%B7%A7"><span class="toc-number">1.3.</span> <span class="toc-text">小技巧:</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9B%E9%98%B6%E9%85%8D%E7%BD%AE"><span class="toc-number">2.</span> <span class="toc-text">进阶配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%A5%E5%BF%97"><span class="toc-number">2.1.</span> <span class="toc-text">日志</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B6%85%E6%97%B6%E6%8E%A7%E5%88%B6"><span class="toc-number">2.2.</span> <span class="toc-text">超时控制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8D%E8%AF%95%E6%9C%BA%E5%88%B6"><span class="toc-number">2.3.</span> <span class="toc-text">重试机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8B%A6%E6%88%AA%E5%99%A8"><span class="toc-number">2.4.</span> <span class="toc-text">拦截器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Fallback-%E5%85%9C%E5%BA%95%E8%BF%94%E5%9B%9E"><span class="toc-number">2.5.</span> <span class="toc-text">*Fallback(兜底返回)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Sentinel"><span class="toc-number"></span> <span class="toc-text">Sentinel</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%95%E5%85%A5"><span class="toc-number">1.</span> <span class="toc-text">引入</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B4%E5%90%88-%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8"><span class="toc-number">2.</span> <span class="toc-text">整合&#x2F;基础使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="toc-number">3.</span> <span class="toc-text">*异常处理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#web%E6%8E%A5%E5%8F%A3"><span class="toc-number">3.1.</span> <span class="toc-text">web接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SentinelResource"><span class="toc-number">3.2.</span> <span class="toc-text">@SentinelResource</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#OpenFeign-1"><span class="toc-number">3.3.</span> <span class="toc-text">OpenFeign</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sphu-entry"><span class="toc-number">3.4.</span> <span class="toc-text">sphu.entry</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%81%E6%8E%A7%E8%A7%84%E5%88%99"><span class="toc-number">4.</span> <span class="toc-text">流控规则</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%81%E6%8E%A7%E6%A8%A1%E5%BC%8F%EF%BC%9A"><span class="toc-number">4.1.</span> <span class="toc-text">流控模式：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%81%E6%8E%A7%E6%95%88%E6%9E%9C"><span class="toc-number">4.2.</span> <span class="toc-text">流控效果</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%86%94%E6%96%AD%E8%A7%84%E5%88%99"><span class="toc-number">5.</span> <span class="toc-text">熔断规则</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%AD%E8%B7%AF%E5%99%A8%E6%8E%A7%E5%88%B6%E5%8E%9F%E7%90%86"><span class="toc-number">5.1.</span> <span class="toc-text">断路器控制原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%86%94%E6%96%AD%E7%AD%96%E7%95%A5"><span class="toc-number">5.2.</span> <span class="toc-text">熔断策略</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%83%AD%E7%82%B9%E8%A7%84%E5%88%99"><span class="toc-number">6.</span> <span class="toc-text">热点规则</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%88%E6%9D%83%E8%A7%84%E5%88%99%E5%92%8C%E7%B3%BB%E7%BB%9F%E8%A7%84%E5%88%99"><span class="toc-number">7.</span> <span class="toc-text">授权规则和系统规则</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8C%81%E4%B9%85%E5%8C%96%E9%85%8D%E7%BD%AE"><span class="toc-number">8.</span> <span class="toc-text">持久化配置</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Gateway"><span class="toc-number"></span> <span class="toc-text">Gateway</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%BD%91%E5%85%B3"><span class="toc-number">1.</span> <span class="toc-text">创建网关</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1"><span class="toc-number">2.</span> <span class="toc-text">路由</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%84%E5%88%99%E9%85%8D%E7%BD%AE"><span class="toc-number">2.1.</span> <span class="toc-text">规则配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-number">2.2.</span> <span class="toc-text">工作原理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%AD%E8%A8%80"><span class="toc-number">3.</span> <span class="toc-text">断言</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%AD%E8%A8%80%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">3.1.</span> <span class="toc-text">断言的使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%96%AD%E8%A8%80%E5%B7%A5%E5%8E%82"><span class="toc-number">3.2.</span> <span class="toc-text">自定义断言工厂</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-number">4.</span> <span class="toc-text">过滤器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E5%AE%9E%E7%8E%B0"><span class="toc-number">4.1.</span> <span class="toc-text">基本实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%BB%98%E8%AE%A4filter"><span class="toc-number">4.2.</span> <span class="toc-text">默认filter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A8%E5%B1%80filter"><span class="toc-number">4.3.</span> <span class="toc-text">全局filter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E8%BF%87%E6%BB%A4%E5%99%A8%E5%B7%A5%E5%8E%82"><span class="toc-number">4.4.</span> <span class="toc-text">自定义过滤器工厂</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E8%B7%A8%E5%9F%9F"><span class="toc-number">4.5.</span> <span class="toc-text">全局跨域</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%9D%E8%80%83-2"><span class="toc-number">4.6.</span> <span class="toc-text">思考</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Seata"><span class="toc-number"></span> <span class="toc-text">Seata</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-number">1.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B4%E5%90%88Seata"><span class="toc-number">2.</span> <span class="toc-text">整合Seata</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%9F%E7%90%86-1"><span class="toc-number">3.</span> <span class="toc-text">原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E9%98%B6%E6%8F%90%E4%BA%A4%E5%8D%8F%E8%AE%AE%E6%B5%81%E7%A8%8B"><span class="toc-number">3.1.</span> <span class="toc-text">二阶提交协议流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9B%E7%A7%8D%E4%BA%8B%E5%8A%A1%E6%A8%A1%E5%BC%8F"><span class="toc-number">3.2.</span> <span class="toc-text">四种事务模式</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Posts</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/04/19/spring%20security/" title="Untitled">Untitled</a><time datetime="2025-04-19T09:22:50.057Z" title="Created 2025-04-19 17:22:50">2025-04-19</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/04/19/MySQL%E8%BF%9B%E9%98%B6/" title="Untitled">Untitled</a><time datetime="2025-04-19T09:22:50.048Z" title="Created 2025-04-19 17:22:50">2025-04-19</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/04/19/String/" title="笔记-String">笔记-String</a><time datetime="2025-04-19T04:46:00.000Z" title="Created 2025-04-19 12:46:00">2025-04-19</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/04/19/MyBatis/" title="笔记-MyBatis">笔记-MyBatis</a><time datetime="2025-04-19T04:46:00.000Z" title="Created 2025-04-19 12:46:00">2025-04-19</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/04/19/git/" title="笔记-git">笔记-git</a><time datetime="2025-04-19T04:46:00.000Z" title="Created 2025-04-19 12:46:00">2025-04-19</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2025 By Muite</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Reading Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light and Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle Between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Settings"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back to Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><!-- hexo injector body_end start --><script data-pjax>
  function butterfly_footer_beautify_injector_config(){
    var parent_div_git = document.getElementById('footer-wrap');
    var item_html = '<div id="workboard"></div><p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px" data-title="博客框架为Hexo_v6.2.0" title=""><img src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&amp;logo=hexo" alt=""/></a><a class="github-badge" target="_blank" href="https://butterfly.js.org/" style="margin-inline:5px" data-title="主题版本Butterfly_v4.3.1" title=""><img src="https://img.shields.io/badge/Theme-Butterfly-6513df?style=flat&amp;logo=bitdefender" alt=""/></a><a class="github-badge" target="_blank" href="https://github.com/" style="margin-inline:5px" data-title="本站项目由Github托管" title=""><img src="https://img.shields.io/badge/Source-Github-d021d6?style=flat&amp;logo=GitHub" alt=""/></a><a class="github-badge" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" style="margin-inline:5px" data-title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可" title=""><img src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&amp;logo=Claris" alt=""/></a></p>';
    console.log('已挂载butterfly_footer_beautify')
    parent_div_git.insertAdjacentHTML("beforeend",item_html)
    }
  var elist = 'null'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_footer_beautify_injector_config();
  }
  else if (epage === cpage){
    butterfly_footer_beautify_injector_config();
  }
  </script><script async src="/js/runtime.js"></script><!-- hexo injector body_end end --></body></html>